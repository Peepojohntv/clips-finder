<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Twitch Clip Finder + Editor</title>
  <style>
    :root{
      --bg0:#07070c; --bg1:#0e0e16; --panel:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.10); --text:#f2f2f5;
      --muted:rgba(242,242,245,.70); --accent:#9146ff;
      --bad:#fb7185; --good:#4ade80;
    }
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:radial-gradient(1200px 700px at 15% 10%,rgba(145,70,255,.18),transparent 60%),radial-gradient(900px 600px at 85% 20%,rgba(180,137,255,.12),transparent 55%),linear-gradient(180deg,var(--bg0),var(--bg1));padding:16px}
    .app{max-width:1400px;margin:0 auto}
    
    /* Topbar */
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(180deg,var(--accent),#6d28d9)}
    .brand h1{margin:0;font-size:15px;font-weight:800}
    .btn{border:0;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:700;color:#fff;background:linear-gradient(180deg,var(--accent),#6d28d9);box-shadow:0 10px 20px rgba(145,70,255,.2);transition:transform .1s}
    .btn:hover{transform:translateY(-1px)}.btn:disabled{opacity:.5;cursor:not-allowed}
    .btnGhost{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);box-shadow:none}
    .account{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(0,0,0,.2)}
    .avatar{width:28px;height:28px;border-radius:999px;overflow:hidden;background:rgba(255,255,255,.1)}.avatar img{width:100%;height:100%;object-fit:cover}
    
    /* Grid */
    .shell{display:grid;grid-template-columns:260px 1fr;gap:14px;align-items:start}
    @media(max-width:900px){.shell{grid-template-columns:1fr}}
    
    .card{border-radius:16px;background:var(--panel);border:1px solid var(--stroke);box-shadow:0 20px 50px rgba(0,0,0,.4);backdrop-filter:blur(12px)}
    .cardHeader{padding:12px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;justify-content:space-between;align-items:center}
    .cardHeader h2{margin:0;font-size:13px;font-weight:800}.cardBody{padding:12px}
    
    /* Sidebar */
    .chanList{display:flex;flex-direction:column;gap:6px;max-height:calc(100vh - 240px);overflow:auto;padding-right:4px}
    .chan{display:flex;align-items:center;gap:8px;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.14);cursor:pointer;transition:all .15s}
    .chan:hover{background:rgba(145,70,255,.15);border-color:rgba(145,70,255,.3);transform:translateX(2px)}
    .chanAva{width:32px;height:32px;border-radius:999px;overflow:hidden;flex:0 0 auto}
    .chanTxt{min-width:0}.chanTxt .t{font-weight:800;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.chanTxt .s{font-size:11px;color:var(--muted)}
    .badgeLive{margin-left:auto;font-size:10px;font-weight:800;padding:4px 8px;border-radius:999px;background:rgba(255,0,0,.25);color:#ff8888;border:1px solid rgba(255,0,0,.3)}
    
    label{display:block;margin:10px 0 6px;color:var(--muted);font-size:12px;font-weight:700}
    input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(10,10,14,.6);color:#fff;outline:none;font-size:13px}
    input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(145,70,255,.15)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    
    /* Clips */
    .results{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;padding:12px}
    .clip{border-radius:12px;overflow:hidden;background:rgba(0,0,0,.2);border:1px solid rgba(255,255,255,.10);cursor:pointer;transition:transform .15s}
    .clip:hover{transform:translateY(-2px);border-color:rgba(145,70,255,.4)}
    .thumbWrap{position:relative;aspect-ratio:16/9;background:rgba(255,255,255,.05)}
    .thumb{width:100%;height:100%;object-fit:cover}
    .duration{position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,.7);padding:4px 8px;border-radius:6px;font-size:11px;font-weight:800}
    .clipBody{padding:10px}.clipTitle{font-size:13px;font-weight:800;margin-bottom:8px;line-height:1.3}
    .meta{display:flex;gap:8px;font-size:11px;color:var(--muted)}
    .tag{padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.05)}
    
    /* Editor Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(8px);z-index:100;display:none;flex-direction:column;align-items:center;justify-content:center;padding:20px}
    .modal.active{display:flex}
    .modalBox{width:100%;max-width:1000px;background:var(--bg1);border:1px solid var(--stroke);border-radius:16px;overflow:hidden;box-shadow:0 30px 80px rgba(0,0,0,.7)}
    .modalHeader{padding:12px;border-bottom:1px solid var(--stroke);display:flex;justify-content:space-between;align-items:center}
    .playerWrap{position:relative;background:#000;aspect-ratio:16/9}
    .playerWrap video{width:100%;height:100%}
    
    /* Timeline */
    .timeline{padding:16px;background:rgba(0,0,0,.3)}
    .timeRow{display:flex;gap:12px;align-items:center;margin-bottom:10px}
    .timeRow label{margin:0;font-size:12px;min-width:50px}
    .timeRow input[type=range]{flex:1}
    .cutList{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;min-height:40px}
    .cutItem{background:rgba(145,70,255,.2);border:1px solid rgba(145,70,255,.4);padding:8px 12px;border-radius:8px;font-size:12px;cursor:pointer;transition:all .15s}
    .cutItem:hover{background:rgba(145,70,255,.3)}
    
    .hint{color:var(--muted);font-size:12px;margin-top:8px}
    .err{color:var(--bad);font-size:12px;margin-top:8px;font-weight:700}
    .spinner{width:16px;height:16px;border:2px solid rgba(255,255,255,.2);border-top-color:var(--accent);border-radius:999px;animation:spin .8s linear infinite;display:none}
    @keyframes spin{to{transform:rotate(360deg)}}
    
    .tabs{display:flex;gap:6px;margin-bottom:10px}
    .tab{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.05);color:#fff;cursor:pointer;font-weight:700;transition:all .15s}
    .tab.active{background:var(--accent);border-color:transparent}
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand"><div class="logo"></div><h1>Twitch Clip Finder + Editor</h1></div>
      <div style="display:flex;gap:10px;align-items:center">
        <button class="btn btnGhost" onclick="toggleSettings()">Einstellungen</button>
        <div class="account" id="accountChip" style="display:none">
          <div class="avatar" id="avatar"></div>
          <div style="font-size:12px;font-weight:800" id="accName">‚Äî</div>
          <button class="btn btnGhost" onclick="logout()" style="padding:6px 10px;font-size:11px">Logout</button>
        </div>
        <button class="btn" id="btnLogin" onclick="login()">Mit Twitch anmelden</button>
      </div>
    </div>

    <div class="shell">
      <!-- Sidebar -->
      <div class="card">
        <div class="cardHeader">
          <h2>Kan√§le</h2>
          <div style="display:flex;gap:4px">
            <button class="btn btnGhost" style="padding:6px 10px;font-size:11px" onclick="setSidebar('follows')">Follows</button>
            <button class="btn btnGhost" style="padding:6px 10px;font-size:11px" onclick="setSidebar('favs')">‚òÖ</button>
          </div>
        </div>
        <div class="cardBody">
          <input id="sideFilter" placeholder="Suchen..." oninput="renderSidebar()" style="margin-bottom:8px">
          <div style="font-size:11px;color:var(--muted);margin-bottom:8px">Klick = in Suche √ºbernehmen</div>
          <div class="chanList" id="chanList"></div>
        </div>
      </div>

      <!-- Main -->
      <div class="card">
        <div class="cardHeader">
          <h2 id="mainTitle">Suche</h2>
          <div style="display:flex;gap:8px;align-items:center">
            <div class="spinner" id="busy"></div>
            <button class="btn btnGhost" onclick="abort()" id="btnAbort" disabled>Stop</button>
          </div>
        </div>
        
        <div class="tabs">
          <button class="tab active" onclick="setTab('search')" id="tabSearch">üîç Suche</button>
          <button class="tab" onclick="setTab('mine')" id="tabMine">üë§ Mein Kanal</button>
        </div>

        <div class="cardBody">
          <div id="viewSearch">
            <label>Streamer (Login)</label>
            <input id="searchLogin" placeholder="z.B. schradin">
            <div class="row" style="margin-top:10px">
              <div><label>Von</label><input type="datetime-local" id="from"></div>
              <div><label>Bis</label><input type="datetime-local" id="to"></div>
            </div>
            <button class="btn" onclick="doSearch()" style="margin-top:12px;width:100%">Clips suchen</button>
          </div>

          <div id="viewMine" style="display:none">
            <div class="hint" id="mineHint">Bitte anmelden...</div>
            <div class="row" style="margin-top:10px">
              <div><label>Von</label><input type="datetime-local" id="mineFrom"></div>
              <div><label>Bis</label><input type="datetime-local" id="mineTo"></div>
            </div>
            <label style="margin-top:10px;display:flex;align-items:center;gap:8px;font-weight:500;cursor:pointer">
              <input type="checkbox" id="mineOnlyByMe" style="width:auto">
              <span>Nur meine erstellten Clips</span>
            </label>
            <button class="btn" onclick="doMine()" id="btnMine" style="margin-top:12px;width:100%" disabled>Meine Clips laden</button>
          </div>
          
          <div class="err" id="error"></div>
        </div>
        
        <div class="results" id="results"></div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal" id="settingsModal" onclick="if(event.target===this)toggleSettings()">
    <div class="modalBox" style="max-width:500px">
      <div class="modalHeader"><h3>Einstellungen</h3><button class="btn btnGhost" onclick="toggleSettings()">Schlie√üen</button></div>
      <div style="padding:20px">
        <label>Client-ID</label>
        <input id="clientId" placeholder="Twitch Client ID">
        <label style="margin-top:12px">Scopes (space-getrennt)</label>
        <input id="scopes" placeholder="user:read:follows clips:edit" value="user:read:follows">
        <div class="hint">F√ºr Follows: user:read:follows</div>
        <button class="btn" onclick="saveSettings()" style="margin-top:12px;width:100%">Speichern</button>
        <button class="btn btnGhost" onclick="clearAll()" style="margin-top:8px;width:100%">Alles l√∂schen</button>
      </div>
    </div>
  </div>

  <!-- Editor Modal (CapCut-Light) -->
  <div class="modal" id="editorModal" onclick="if(event.target===this)closeEditor()">
    <div class="modalBox">
      <div class="modalHeader">
        <h3>üé¨ Clip Editor (Schnitt-Planer)</h3>
        <div>
          <button class="btn btnGhost" onclick="downloadCurrentClip()">‚¨áÔ∏è Download MP4</button>
          <button class="btn" onclick="closeEditor()">Schlie√üen</button>
        </div>
      </div>
      
      <div class="playerWrap">
        <video id="editorVideo" controls playsinline></video>
      </div>
      
      <div class="timeline">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div style="font-size:13px;font-weight:700" id="editorTitle">Clip</div>
          <div style="font-size:12px;color:var(--muted)">Gesamt: <span id="editorDuration">0:00</span></div>
        </div>
        
        <div class="timeRow">
          <label>Start</label>
          <input type="range" id="cutStart" min="0" max="100" value="0" step="1" oninput="updateCut()">
          <span id="startTime" style="font-size:12px;min-width:50px;text-align:right">0s</span>
        </div>
        <div class="timeRow">
          <label>Ende</label>
          <input type="range" id="cutEnd" min="0" max="100" value="100" step="1" oninput="updateCut()">
          <span id="endTime" style="font-size:12px;min-width:50px;text-align:right">0s</span>
        </div>
        
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn" onclick="addCut()" style="flex:1">‚úÇÔ∏è Ausschnitt speichern</button>
          <button class="btn btnGhost" onclick="playCut()" style="flex:1">‚ñ∂Ô∏è Vorschau</button>
        </div>
        
        <div class="hint">Gespeicherte Schnitte (lokal):</div>
        <div class="cutList" id="cutList"></div>
      </div>
    </div>
  </div>

<script>
const LS = { cid:'tcf_cid', tok:'tcf_tok', scp:'tcf_scp', favs:'tcf_favs', cuts:'tcf_cuts' };
let me=null, abortController=null, follows=[], favs=[], currentClip=null, currentVideoUrl=null;

function $(id){return document.getElementById(id)}
function toast(msg,type='good'){alert((type==='bad'?'‚ùå ':'‚úÖ ')+msg)} // simplified toast

function getCid(){return $(cid).value.trim()}
function getTok(){return localStorage.getItem(LS.tok)||''}

async function helix(path,params={}){
  const u=new URL('https://api.twitch.tv/helix'+path);
  Object.entries(params).forEach(([k,v])=>{if(v!=null)u.searchParams.set(k,String(v))});
  const r=await fetch(u.toString(),{headers:{'Client-ID':getCid(),'Authorization':'Bearer '+getTok()},signal:abortController?.signal});
  const t=await r.text(); let j=null; try{j=JSON.parse(t)}catch{}
  if(!r.ok)throw new Error(j?.message||j?.error||'HTTP '+r.status);
  return j;
}

/* ========== Auth ========== */
function parseHash(){
  if(!location.hash.includes('access_token'))return false;
  const p=new URLSearchParams(location.hash.slice(1));
  const t=p.get('access_token');
  if(t){localStorage.setItem(LS.tok,t);localStorage.setItem(LS.scp,$(scopes).value);toast('Login OK');}
  history.replaceState(null,'',location.pathname+location.search);
  return true;
}

function buildAuthUrl(){
  const cid=getCid(), redir=location.origin+location.pathname, state=Math.random().toString(36).slice(2);
  const scp=$(scopes).value.trim();
  let url=`https://id.twitch.tv/oauth2/authorize?client_id=${cid}&redirect_uri=${redir}&response_type=token&state=${state}`;
  if(scp)url+=`&scope=${encodeURIComponent(scp)}`;
  return url;
}

function login(){
  if(!getCid()){toast('Client-ID fehlt!','bad');toggleSettings();return;}
  localStorage.setItem(LS.cid,getCid());localStorage.setItem(LS.scp,$(scopes).value);
  location.href=buildAuthUrl();
}

function logout(){localStorage.removeItem(LS.tok);me=null;updateUI();toast('Ausgeloggt')}

function saveSettings(){
  localStorage.setItem(LS.cid,getCid());localStorage.setItem(LS.scp,$(scopes).value);
  toast('Gespeichert');toggleSettings();
}

function clearAll(){
  [LS.cid,LS.tok,LS.scp,LS.favs,LS.cuts].forEach(k=>localStorage.removeItem(k));
  $(cid).value='';$(scopes).value='user:read:follows';favs=[];follows=[];
  updateUI();toast('Alles gel√∂scht');
}

/* ========== Data ========== */
async function loadMe(){
  const j=await helix('/users');
  me=j.data?.[0]; updateUI();
  if(me)loadAllFollows(); // Load ALL follows now
}

async function loadAllFollows(){
  // WICHTIG: L√§dt ALLE Seiten, nicht nur 300!
  follows=[]; let cursor=null, safety=0;
  $('chanList').innerHTML='<div class="hint">Lade Follows...</div>';
  
  try{
    while(safety<50){ // Max 5000 Follows
      const j=await helix('/channels/followed',{user_id:me.id,first:100,after:cursor});
      const data=j.data||[];
      follows.push(...data);
      cursor=j.pagination?.cursor;
      if(!cursor||data.length===0)break;
      safety++;
      await new Promise(r=>setTimeout(r,120)); // Rate limit friendly
    }
    
    // Enrich with profile images (batched)
    const ids=follows.map(x=>x.broadcaster_id).filter(Boolean);
    const idMap=new Map();
    for(let i=0;i<ids.length;i+=100){
      const chunk=ids.slice(i,i+100);
      const u=new URL('https://api.twitch.tv/helix/users');
      chunk.forEach(id=>u.searchParams.append('id',id));
      const j=await fetch(u.toString(),{headers:{'Client-ID':getCid(),'Authorization':'Bearer '+getTok()}}).then(r=>r.json());
      (j.data||[]).forEach(u=>idMap.set(u.id,u));
      await new Promise(r=>setTimeout(r,100));
    }
    
    follows=follows.map(f=>{
      const u=idMap.get(f.broadcaster_id);
      return{...f,login:f.broadcaster_login,display_name:u?.display_name||f.broadcaster_name,profile_image_url:u?.profile_image_url||''};
    }).sort((a,b)=>(a.login||'').localeCompare(b.login||''));
    
    renderSidebar();
  }catch(e){
    follows=[];
    renderSidebar();
    toast('Follows konnten nicht geladen (Scope fehlt?)','bad');
  }
}

/* ========== UI ========== */
function updateUI(){
  const has=!!getTok();
  $('btnLogin').style.display=has?'none':'block';
  $('accountChip').style.display=has?'flex':'none';
  if(me){
    $('accName').textContent=me.display_name||me.login;
    $('avatar').innerHTML=me.profile_image_url?`<img src="${me.profile_image_url}">`:'';
    $('mineHint').innerHTML=`Angemeldet als <b>${me.login}</b>`;
    $('btnMine').disabled=false;
  }else{
    $('mineHint').textContent='Bitte anmelden...';
    $('btnMine').disabled=true;
  }
  if(!has)$('chanList').innerHTML='<div class="hint">Anmelden um Follows zu sehen</div>';
}

function setTab(t){
  const isS=t==='search';
  $('tabSearch').classList.toggle('active',isS);
  $('tabMine').classList.toggle('active',!isS);
  $('viewSearch').style.display=isS?'block':'none';
  $('viewMine').style.display=isS?'none':'block';
  $('mainTitle').textContent=isS?'Suche':'Mein Kanal';
}

function setSidebar(mode){
  renderSidebar(mode);
}

function renderSidebar(mode='follows'){
  const list=mode==='follows'?follows:favs;
  const q=$('sideFilter').value.toLowerCase();
  const filtered=list.filter(x=>(x.login||x.broadcaster_login||'').toLowerCase().includes(q)||(x.display_name||'').toLowerCase().includes(q));
  
  if(!filtered.length){
    $('chanList').innerHTML='<div class="hint">Keine Eintr√§ge</div>';return;
  }
  
  $('chanList').innerHTML=filtered.map(c=>`
    <div class="chan" onclick="selectChan('${c.login||c.broadcaster_login}')">
      <div class="chanAva">${c.profile_image_url?`<img src="${c.profile_image_url}">`:''}</div>
      <div class="chanTxt"><div class="t">${c.display_name||c.broadcaster_name||c.login}</div><div class="s">@${c.login||c.broadcaster_login}</div></div>
    </div>
  `).join('');
}

function selectChan(login){
  $('searchLogin').value=login;
  setTab('search');
  doSearch();
}

/* ========== Search ========== */
function toISO(d){const x=new Date(d);return isNaN(x)?null:x.toISOString()}
function formatDate(iso){return new Date(iso).toLocaleString('de-DE',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'})}

async function doSearch(){
  const login=$('searchLogin').value.trim();
  const from=toISO($('from').value), to=toISO($('to').value);
  if(!login||!from||!to){toast('Bitte alles ausf√ºllen','bad');return}
  
  abortController=new AbortController();
  $('busy').style.display='block';$('btnAbort').disabled=false;$('error').textContent='';
  
  try{
    const u=await helix('/users',{login});
    const user=u.data?.[0]; if(!user)throw new Error('Kanal nicht gefunden');
    
    const clips=await fetchAllClips(user.id,from,to);
    renderClips(clips);
  }catch(e){
    $('error').textContent=e.message;
    toast(e.message,'bad');
  }finally{
    $('busy').style.display='none';$('btnAbort').disabled=true;abortController=null;
  }
}

async function doMine(){
  if(!me)return;
  const from=toISO($('mineFrom').value), to=toISO($('mineTo').value);
  if(!from||!to){toast('Zeitraum w√§hlen','bad');return}
  
  abortController=new AbortController();
  $('busy').style.display='block';$('btnAbort').disabled=false;$('error').textContent='';
  
  try{
    let clips=await fetchAllClips(me.id,from,to);
    if($('mineOnlyByMe').checked)clips=clips.filter(c=>c.creator_id===me.id);
    renderClips(clips);
  }catch(e){
    $('error').textContent=e.message;
  }finally{
    $('busy').style.display='none';$('btnAbort').disabled=true;abortController=null;
  }
}

async function fetchAllClips(bid,start,end){
  const all=[], seen=new Set();
  let cursor=null, safety=0;
  const startMs=new Date(start).getTime(), endMs=new Date(end).getTime();
  
  while(safety<20){
    const j=await helix('/clips',{broadcaster_id:bid,started_at:start,ended_at:end,first:100,after:cursor});
    const data=j.data||[];
    data.forEach(c=>{if(!seen.has(c.id)){seen.add(c.id);all.push(c);}});
    cursor=j.pagination?.cursor;
    if(!cursor||data.length===0)break;
    safety++; await new Promise(r=>setTimeout(r,120));
  }
  return all.sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
}

function renderClips(clips){
  if(!clips.length){$('results').innerHTML='<div class="hint" style="padding:20px">Keine Clips gefunden</div>';return;}
  
  $('results').innerHTML=clips.map(c=>{
    const thumb=(c.thumbnail_url||'').replace('%{width}','640').replace('%{height}','360');
    const dur=formatDuration(c.duration);
    return`
    <div class="clip" onclick="openEditor('${c.id}','${c.url}','${thumb}','${c.title?.replace(/'/g,"\\'")}')">
      <div class="thumbWrap">
        <img class="thumb" src="${thumb}">
        <div class="duration">${dur}</div>
      </div>
      <div class="clipBody">
        <div class="clipTitle">${c.title||'(kein Titel)'}</div>
        <div class="meta">
          <span class="tag">üëÅÔ∏è ${c.view_count}</span>
          <span class="tag">üìÖ ${formatDate(c.created_at)}</span>
          <span class="tag">‚úÇÔ∏è ${c.creator_name}</span>
        </div>
      </div>
    </div>`;
  }).join('');
}

function formatDuration(sec){
  if(!sec)return '0:00';
  const m=Math.floor(sec/60), s=Math.floor(sec%60);
  return `${m}:${s.toString().padStart(2,'0')}`;
}

function abort(){abortController?.abort()}

/* ========== Editor (CapCut Light) ========== */
function openEditor(id,url,thumb,title){
  // Try to get MP4 URL (Twitch sometimes allows this via embed)
  // We'll use the clip URL and try to extract a direct video or use iframe as fallback
  currentClip={id,url,title,thumb};
  
  // Show modal
  $('editorModal').classList.add('active');
  $('editorTitle').textContent=title;
  
  // For the editor, we try to use the clip URL directly in video tag (may not work due to CORS, but we try)
  $('editorVideo').src=url; // This may redirect or fail, but it's the best we can do without backend
  $('editorVideo').load();
  
  // Reset sliders
  $('cutStart').value=0; $('cutEnd').value=100;
  updateCut();
  loadCuts();
}

function closeEditor(){$('editorModal').classList.remove('active');$('editorVideo').pause();$('editorVideo').src=''}

function updateCut(){
  const vid=$('editorVideo');
  if(!vid.duration)return;
  
  const startPct=parseInt($('cutStart').value);
  const endPct=parseInt($('cutEnd').value);
  
  // Ensure start < end
  if(startPct>=endPct){$('cutEnd').value=startPct+1;return updateCut()}
  
  const startSec=(startPct/100)*vid.duration;
  const endSec=(endPct/100)*vid.duration;
  
  $('startTime').textContent=startSec.toFixed(1)+'s';
  $('endTime').textContent=endSec.toFixed(1)+'s';
  $('editorDuration').textContent=formatDuration(vid.duration);
}

function addCut(){
  if(!currentClip)return;
  const vid=$('editorVideo');
  if(!vid.duration){toast('Video noch nicht geladen','bad');return}
  
  const s=parseInt($('cutStart').value)/100*vid.duration;
  const e=parseInt($('cutEnd').value)/100*vid.duration;
  
  const cuts=JSON.parse(localStorage.getItem(LS.cuts)||'[]');
  cuts.push({
    id:currentClip.id,
    title:currentClip.title,
    start:s,
    end:e,
    created:new Date().toISOString()
  });
  localStorage.setItem(LS.cuts,JSON.stringify(cuts));
  loadCuts();
  toast('Schnitt gespeichert!');
}

function loadCuts(){
  const cuts=JSON.parse(localStorage.getItem(LS.cuts)||'[]');
  const recent=cuts.slice(-10); // Show last 10
  $('cutList').innerHTML=recent.map((c,i)=>`
    <div class="cutItem" onclick="jumpToCut(${i})">
      <b>${c.title?.slice(0,20)||'Clip'}</b><br>
      ${c.start.toFixed(0)}s - ${c.end.toFixed(0)}s
    </div>
  `).join('')||'<div class="hint">Noch keine Schnitte</div>';
}

function jumpToCut(idx){
  const cuts=JSON.parse(localStorage.getItem(LS.cuts)||'[]');
  const c=cuts[idx]; if(!c)return;
  $('cutStart').value=(c.start/$('editorVideo').duration)*100;
  $('cutEnd').value=(c.end/$('editorVideo').duration)*100;
  updateCut();
  $('editorVideo').currentTime=c.start;
}

function playCut(){
  const vid=$('editorVideo');
  const s=parseInt($('cutStart').value)/100*vid.duration;
  vid.currentTime=s;
  vid.play();
}

function downloadCurrentClip(){
  if(!currentClip)return;
  // Open the clip URL in new tab - actual download requires backend due to CORS/DRM
  window.open(currentClip.url+'?download=1','_blank');
  toast('√ñffne Clip... (Download nur m√∂glich wenn Twitch erlaubt)');
}

function toggleSettings(){
  const m=$('settingsModal');
  m.classList.toggle('active');
  if(m.classList.contains('active')){
    $(cid).value=localStorage.getItem(LS.cid)||'';
    $(scopes).value=localStorage.getItem(LS.scp)||'user:read:follows';
  }
}

/* ========== Init ========== */
const cid='clientId', scp='scopes';
$(cid).value=localStorage.getItem(LS.cid)||'';
$(scp).value=localStorage.getItem(LS.scp)||'user:read:follows';

// Default dates
const now=new Date(), ago=new Date(now-60*60*1000);
$('to').value=now.toISOString().slice(0,16);
$('from').value=ago.toISOString().slice(0,16);
$('mineTo').value=$('to').value;
$('mineFrom').value=$('from').value;

if(parseHash()){setTimeout(loadMe,100)}
else if(getTok()){loadMe()}

// Video metadata loaded listener for editor
$('editorVideo').addEventListener('loadedmetadata',updateCut);
</script>
</body>
</html>
