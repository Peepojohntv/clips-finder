<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitch Studio - Clip Finder & Editor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0e0e10; 
            color: #efeff1;
            min-height: 100vh;
        }
        
        /* Layout */
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 20px;
            background: #18181b;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .brand { display: flex; align-items: center; gap: 12px; }
        .logo { 
            width: 40px; 
            height: 40px; 
            background: linear-gradient(135deg, #9146ff, #5c16c5);
            border-radius: 10px;
            display: grid;
            place-items: center;
            font-size: 20px;
        }
        
        .btn { 
            padding: 10px 20px; 
            background: #9146ff; 
            color: white; 
            border: none; 
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn:hover { background: #a970ff; transform: translateY(-2px); }
        .btn-secondary { background: rgba(255,255,255,0.1); }
        .btn-secondary:hover { background: rgba(255,255,255,0.2); }
        
        .grid { display: grid; grid-template-columns: 280px 1fr; gap: 20px; }
        @media(max-width: 900px) { .grid { grid-template-columns: 1fr; } }
        
        .card { 
            background: #18181b; 
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
        }
        
        /* Sidebar */
        .channel-list { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
        .channel-item { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            padding: 10px; 
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .channel-item:hover { background: rgba(145,70,255,0.2); transform: translateX(5px); }
        .channel-img { width: 32px; height: 32px; border-radius: 50%; background: #333; }
        
        /* Form */
        input { 
            width: 100%; 
            padding: 12px; 
            margin: 8px 0;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            border-radius: 8px;
        }
        input:focus { outline: none; border-color: #9146ff; }
        
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        /* Clips */
        .clips-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 20px; 
            margin-top: 20px;
        }
        .clip { 
            background: #1f1f23; 
            border-radius: 12px; 
            overflow: hidden; 
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
        }
        .clip:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .clip-thumb { width: 100%; aspect-ratio: 16/9; background: #333; position: relative; }
        .clip-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .clip-duration { 
            position: absolute; 
            bottom: 8px; 
            right: 8px; 
            background: rgba(0,0,0,0.8);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .clip-edit { 
            position: absolute; 
            top: 8px; 
            right: 8px; 
            background: #9146ff; 
            padding: 6px 12px; 
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .clip:hover .clip-edit { opacity: 1; }
        .clip-info { padding: 15px; }
        .clip-title { font-weight: 700; margin-bottom: 8px; font-size: 15px; }
        .clip-meta { display: flex; gap: 12px; color: #adadb8; font-size: 13px; }
        
        /* Editor Modal */
        .modal { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            padding: 20px;
            overflow: auto;
        }
        .modal.active { display: block; }
        
        .editor { 
            max-width: 1100px; 
            margin: 0 auto; 
            background: #18181b;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .video-area { 
            background: #000; 
            aspect-ratio: 16/9; 
            position: relative;
        }
        .video-area video { width: 100%; height: 100%; }
        
        /* CapCut Timeline */
        .timeline { 
            padding: 20px; 
            background: #0e0e10;
        }
        .track { 
            height: 60px; 
            background: #2d2d35; 
            border-radius: 8px; 
            position: relative;
            margin: 20px 0;
            cursor: pointer;
        }
        .selection { 
            position: absolute; 
            top: 0; 
            bottom: 0; 
            background: rgba(145,70,255,0.3); 
            border: 2px solid #9146ff;
        }
        .handle { 
            position: absolute; 
            top: -5px; 
            bottom: -5px; 
            width: 12px; 
            background: #9146ff; 
            cursor: ew-resize;
            border-radius: 3px;
        }
        .playhead { 
            position: absolute; 
            top: -10px; 
            bottom: -10px; 
            width: 2px; 
            background: #ff0050; 
            pointer-events: none;
        }
        
        .controls { 
            display: flex; 
            justify-content: center; 
            gap: 15px; 
            padding: 20px;
            background: #1f1f23;
        }
        
        .export-bar { 
            padding: 15px 20px; 
            background: #18181b;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .hidden { display: none !important; }
        .toast { 
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            background: #18181b;
            padding: 15px 25px;
            border-radius: 8px;
            border-left: 4px solid #9146ff;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: slideIn 0.3s ease;
            z-index: 2000;
        }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body>

<div class="container">
    <!-- Header -->
    <div class="header">
        <div class="brand">
            <div class="logo">üé¨</div>
            <div>
                <h1 style="font-size: 20px;">Twitch Studio</h1>
                <div style="font-size: 12px; color: #adadb8;">Clip Finder & CapCut Editor</div>
            </div>
        </div>
        
        <div style="display: flex; gap: 10px; align-items: center;">
            <button class="btn btn-secondary" onclick="toggleSettings()">‚öôÔ∏è Settings</button>
            <div id="userChip" class="hidden" style="display: flex; align-items: center; gap: 10px;">
                <img id="userImg" style="width: 32px; height: 32px; border-radius: 50%;">
                <span id="userName" style="font-weight: 600;"></span>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
            <button id="loginBtn" class="btn" onclick="login()">Mit Twitch anmelden</button>
        </div>
    </div>

    <div class="grid">
        <!-- Sidebar -->
        <div>
            <div class="card">
                <h3 style="margin-bottom: 15px;">‚≠ê Favoriten</h3>
                <input type="text" id="newFav" placeholder="Kanal hinzuf√ºgen..." onkeypress="if(event.key==='Enter')addFav()">
                <div id="favList" class="channel-list"></div>
            </div>
        </div>

        <!-- Main -->
        <div class="card">
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn" onclick="showView('search')" id="btnSearch">üîç Suche</button>
                <button class="btn btn-secondary" onclick="showView('mine')" id="btnMine">üë§ Meine Clips</button>
            </div>

            <!-- Search View -->
            <div id="viewSearch">
                <input type="text" id="searchLogin" placeholder="Streamer Login (z.B. schradin)">
                <div class="row">
                    <input type="datetime-local" id="dateFrom">
                    <input type="datetime-local" id="dateTo">
                </div>
                <button class="btn" onclick="doSearch()" style="width: 100%; margin-top: 10px;">Suchen</button>
            </div>

            <!-- My View -->
            <div id="viewMine" class="hidden">
                <div class="row">
                    <input type="datetime-local" id="myFrom">
                    <input type="datetime-local" id="myTo">
                </div>
                <label style="display: flex; align-items: center; gap: 8px; margin: 10px 0; cursor: pointer;">
                    <input type="checkbox" id="onlyMine"> Nur meine erstellten Clips
                </label>
                <button class="btn" onclick="loadMyClips()" style="width: 100%;">Laden</button>
            </div>

            <div id="clipsArea" class="clips-grid"></div>
        </div>
    </div>
</div>

<!-- Settings -->
<div id="settingsModal" class="modal" onclick="if(event.target==this)toggleSettings()">
    <div class="card" style="max-width: 400px; margin: 100px auto;">
        <h3 style="margin-bottom: 15px;">Einstellungen</h3>
        <input type="text" id="clientId" placeholder="Twitch Client ID">
        <input type="text" id="scopes" placeholder="Scopes" value="user:read:follows">
        <button class="btn" onclick="saveSettings()" style="width: 100%; margin-top: 10px;">Speichern</button>
        <button class="btn btn-secondary" onclick="pasteToken()" style="width: 100%; margin-top: 8px;">Token eingeben</button>
    </div>
</div>

<!-- CapCut Editor -->
<div id="editorModal" class="modal">
    <div class="editor">
        <div style="padding: 20px; display: flex; justify-content: space-between; align-items: center;">
            <h3>‚úÇÔ∏è CapCut Editor</h3>
            <div>
                <button class="btn" onclick="saveProject()">üíæ Speichern</button>
                <button class="btn btn-secondary" onclick="closeEditor()">‚úï</button>
            </div>
        </div>
        
        <div class="video-area">
            <video id="editVideo" controls playsinline></video>
        </div>
        
        <div class="timeline">
            <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 10px;">
                <button class="btn btn-secondary" onclick="videoControl('play')">‚ñ∂</button>
                <button class="btn btn-secondary" onclick="videoControl('pause')">‚è∏</button>
                <button class="btn btn-secondary" onclick="markStart()">Start markieren</button>
                <button class="btn btn-secondary" onclick="markEnd()">Ende markieren</button>
            </div>
            
            <div class="track" id="track" onclick="seek(event)">
                <div class="selection" id="selection" style="left: 0%; width: 100%;">
                    <div class="handle" id="hStart" style="left: 0;" onmousedown="dragStart('start', event)"></div>
                    <div class="handle" id="hEnd" style="right: 0;" onmousedown="dragStart('end', event)"></div>
                </div>
                <div class="playhead" id="playhead" style="left: 0%;"></div>
            </div>
            
            <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-top: 5px;">
                <span>0:00</span>
                <span id="timeStart">Start: 0:00</span>
                <span id="timeEnd">Ende: 0:00</span>
            </div>
        </div>
        
        <div class="export-bar">
            <span style="color: #adadb8; font-size: 14px;">Export: Nur Links m√∂glich (Browser Limit)</span>
            <div>
                <button class="btn btn-secondary" onclick="copyLink()">Link kopieren</button>
                <button class="btn" onclick="openTwitch()">Auf Twitch √∂ffnen</button>
            </div>
        </div>
    </div>
</div>

<script>
const LS = { cid: 'tc_cid', tok: 'tc_tok', fav: 'tc_fav', cut: 'tc_cut' };
let me = null, currentClip = null, start = 0, end = 0, duration = 0;

// Init
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('clientId').value = localStorage.getItem(LS.cid) || '';
    document.getElementById('scopes').value = localStorage.getItem(LS.scp) || 'user:read:follows';
    
    const now = new Date(), yesterday = new Date(now - 86400000);
    const fmt = d => d.toISOString().slice(0, 16);
    ['dateFrom', 'dateTo', 'myFrom', 'myTo'].forEach(id => {
        document.getElementById(id).value = fmt(id.includes('From') ? yesterday : now);
    });
    
    loadFavs();
    if (location.hash.includes('access_token')) {
        const p = new URLSearchParams(location.hash.slice(1));
        localStorage.setItem(LS.tok, p.get('access_token'));
        history.replaceState(null, '', location.pathname);
        initUser();
    } else if (localStorage.getItem(LS.tok)) {
        initUser();
    }
});

async function api(path, params = {}) {
    const u = new URL('https://api.twitch.tv/helix' + path);
    Object.entries(params).forEach(([k, v]) => v && u.searchParams.append(k, v));
    const r = await fetch(u, { headers: { 'Client-ID': getCid(), 'Authorization': 'Bearer ' + localStorage.getItem(LS.tok) } });
    if (!r.ok) throw new Error((await r.json()).message || 'API Error');
    return r.json();
}

function getCid() { return document.getElementById('clientId').value || localStorage.getItem(LS.cid) || ''; }

function login() {
    if (!getCid()) return toggleSettings();
    localStorage.setItem(LS.cid, getCid());
    localStorage.setItem(LS.scp, document.getElementById('scopes').value);
    location.href = `https://id.twitch.tv/oauth2/authorize?client_id=${getCid()}&redirect_uri=${location.origin + location.pathname}&response_type=token&scope=${document.getElementById('scopes').value}`;
}

async function initUser() {
    try {
        const u = await api('/users');
        me = u.data[0];
        document.getElementById('loginBtn').classList.add('hidden');
        document.getElementById('userChip').classList.remove('hidden');
        document.getElementById('userName').textContent = me.display_name;
        document.getElementById('userImg').src = me.profile_image_url;
        if (!favs.some(f => f.login === me.login)) addFav(me.login, me.display_name, me.profile_image_url);
    } catch (e) { logout(); }
}

function logout() { localStorage.removeItem(LS.tok); location.reload(); }

// Favorites
let favs = [];
function loadFavs() {
    try { favs = JSON.parse(localStorage.getItem(LS.fav)) || []; } catch(e) { favs = []; }
    renderFavs();
}

function renderFavs() {
    document.getElementById('favList').innerHTML = favs.map(f => `
        <div class="channel-item" onclick="selectChannel('${f.login}')">
            <img src="${f.img || 'https://static-cdn.jtvnw.net/user-default-pictures-uv/13e5fa74-defa-11e9-809c-784f43822e80-profile_image-70x70.png'}" class="channel-img">
            <div style="flex: 1;">
                <div style="font-weight: 600;">${f.name}</div>
                <div style="font-size: 12px; color: #666;">@${f.login}</div>
            </div>
            ${f.login !== me?.login ? `<button onclick="event.stopPropagation(); removeFav('${f.login}')" style="background:none;border:none;color:#f00;cursor:pointer;">üóë</button>` : ''}
        </div>
    `).join('');
}

function addFav(login, name, img) {
    login = login || document.getElementById('newFav').value.trim();
    if (!login) return;
    if (!favs.some(f => f.login === login)) {
        favs.push({ login, name: name || login, img: img || '' });
        saveFavs();
        document.getElementById('newFav').value = '';
    }
}

function removeFav(login) { favs = favs.filter(f => f.login !== login); saveFavs(); }
function saveFavs() { localStorage.setItem(LS.fav, JSON.stringify(favs)); renderFavs(); }
function selectChannel(l) { document.getElementById('searchLogin').value = l; showView('search'); doSearch(); }

// Views
function showView(v) {
    document.getElementById('viewSearch').classList.toggle('hidden', v !== 'search');
    document.getElementById('viewMine').classList.toggle('hidden', v !== 'mine');
    document.getElementById('btnSearch').className = v === 'search' ? 'btn' : 'btn btn-secondary';
    document.getElementById('btnMine').className = v === 'mine' ? 'btn' : 'btn btn-secondary';
}

// Search
async function doSearch() {
    const login = document.getElementById('searchLogin').value;
    if (!login) return alert('Login eingeben');
    await fetchClips(login, document.getElementById('dateFrom').value, document.getElementById('dateTo').value);
}

async function loadMyClips() {
    if (!me) return alert('Bitte anmelden');
    let clips = await fetchClips(me.login, document.getElementById('myFrom').value, document.getElementById('myTo').value);
    if (document.getElementById('onlyMine').checked) clips = clips.filter(c => c.creator_id === me.id);
    renderClips(clips);
}

async function fetchClips(login, from, to) {
    document.getElementById('clipsArea').innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px;">Lade...</div>';
    try {
        const u = await api('/users', { login });
        if (!u.data[0]) throw new Error('Kanal nicht gefunden');
        const all = [], seen = new Set();
        let cursor = null;
        for (let i = 0; i < 10; i++) {
            const p = { broadcaster_id: u.data[0].id, started_at: new Date(from).toISOString(), ended_at: new Date(to).toISOString(), first: 100 };
            if (cursor) p.after = cursor;
            const r = await api('/clips', p);
            r.data.forEach(c => { if (!seen.has(c.id)) { seen.add(c.id); all.push(c); } });
            cursor = r.pagination?.cursor;
            if (!cursor) break;
        }
        renderClips(all.sort((a,b) => new Date(b.created_at) - new Date(a.created_at)));
        return all;
    } catch (e) { alert(e.message); }
}

function renderClips(clips) {
    document.getElementById('clipsArea').innerHTML = clips.map(c => `
        <div class="clip" onclick="openEditor('${c.id}', '${c.url}', '${c.thumbnail_url.replace(/%/g, '%%')}', '${c.title.replace(/'/g, "\\'")}', ${c.duration})">
            <div class="clip-thumb">
                <img src="${c.thumbnail_url.replace('%{width}', '640').replace('%{height}', '360')}" loading="lazy">
                <div class="clip-duration">${fmtDur(c.duration)}</div>
                <div class="clip-edit">BEARBEITEN</div>
            </div>
            <div class="clip-info">
                <div class="clip-title">${c.title}</div>
                <div class="clip-meta">
                    <span>üëÅÔ∏è ${c.view_count}</span>
                    <span>‚úÇÔ∏è ${c.creator_name}</span>
                </div>
            </div>
        </div>
    `).join('');
}

// Editor
function openEditor(id, url, thumb, title, dur) {
    currentClip = { id, url, title };
    document.getElementById('editorModal').classList.add('active');
    const v = document.getElementById('editVideo');
    v.src = url;
    v.load();
    v.onloadedmetadata = () => {
        duration = v.duration || dur || 60;
        end = duration;
        updateTimeline();
    };
    v.ontimeupdate = () => {
        document.getElementById('playhead').style.left = ((v.currentTime / duration) * 100) + '%';
        if (v.currentTime >= end) { v.currentTime = start; if (!v.paused) v.play(); }
    };
}

function closeEditor() { document.getElementById('editorModal').classList.remove('active'); document.getElementById('editVideo').pause(); }
function videoControl(c) { const v = document.getElementById('editVideo'); c === 'play' ? v.play() : v.pause(); }
function markStart() { start = document.getElementById('editVideo').currentTime; if (start > end) end = duration; updateTimeline(); }
function markEnd() { end = document.getElementById('editVideo').currentTime; if (end < start) start = 0; updateTimeline(); }
function updateTimeline() {
    document.getElementById('selection').style.left = (start / duration * 100) + '%';
    document.getElementById('selection').style.width = ((end - start) / duration * 100) + '%';
    document.getElementById('timeStart').textContent = 'Start: ' + fmtDur(start);
    document.getElementById('timeEnd').textContent = 'Ende: ' + fmtDur(end);
}

function seek(e) {
    const rect = document.getElementById('track').getBoundingClientRect();
    const pct = (e.clientX - rect.left) / rect.width;
    document.getElementById('editVideo').currentTime = pct * duration;
}

function dragStart(type, e) {
    e.stopPropagation();
    const move = (ev) => {
        const rect = document.getElementById('track').getBoundingClientRect();
        const pct = Math.max(0, Math.min(1, (ev.clientX - rect.left) / rect.width));
        const time = pct * duration;
        if (type === 'start') start = Math.min(time, end - 1);
        else end = Math.max(time, start + 1);
        updateTimeline();
    };
    const up = () => { document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', up); };
    document.addEventListener('mousemove', move);
    document.addEventListener('mouseup', up);
}

function saveProject() {
    const p = JSON.parse(localStorage.getItem(LS.cut) || '[]');
    p.push({ ...currentClip, start, end, date: new Date().toISOString() });
    localStorage.setItem(LS.cut, JSON.stringify(p));
    toast('Projekt gespeichert!');
}

function copyLink() { navigator.clipboard.writeText(`${currentClip.url}?t=${Math.floor(start)}s`); toast('Link kopiert!'); }
function openTwitch() { window.open(`${currentClip.url}?t=${Math.floor(start)}s`, '_blank'); }

// Utils
function fmtDur(s) { const m = Math.floor(s / 60), sec = Math.floor(s % 60); return `${m}:${sec.toString().padStart(2, '0')}`; }
function toggleSettings() { document.getElementById('settingsModal').classList.toggle('active'); }
function saveSettings() { localStorage.setItem(LS.cid, document.getElementById('clientId').value); localStorage.setItem(LS.scp, document.getElementById('scopes').value); toggleSettings(); toast('Gespeichert'); }
function pasteToken() { const t = prompt('Token:'); if (t) { localStorage.setItem(LS.tok, t); initUser(); } }
function toast(m) { const t = document.createElement('div'); t.className = 'toast'; t.textContent = m; document.body.appendChild(t); setTimeout(() => t.remove(), 3000); }
</script>

</body>
</html>
