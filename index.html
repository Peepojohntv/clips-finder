<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitch Studio - Clip Finder & Editor</title>
    <style>
        :root {
            --bg0: #0e0e10; --bg1: #18181b; --bg2: #1f1f23;
            --panel: rgba(255,255,255,0.05); --border: rgba(255,255,255,0.1);
            --text: #efeff1; --muted: #adadb8; --accent: #9146ff;
            --accent-light: #a970ff; --danger: #eb0400; --success: #00f593;
            --timeline: #2d2d35; --track: #3d3d45; --playhead: #ff0050;
            --selection: rgba(145,70,255,0.35);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg0); color: var(--text); min-height: 100vh;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        /* Header */
        .header { 
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 20px; background: var(--panel); border: 1px solid var(--border);
            border-radius: 12px; margin-bottom: 20px;
        }
        .logo { 
            width: 40px; height: 40px; background: linear-gradient(135deg, var(--accent), #5c16c5);
            border-radius: 10px; display: grid; place-items: center; font-size: 20px;
        }
        .btn { 
            padding: 10px 18px; background: var(--accent); color: white; border: none;
            border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;
        }
        .btn:hover { background: var(--accent-light); transform: translateY(-2px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary { background: rgba(255,255,255,0.1); border: 1px solid var(--border); }
        .btn-secondary:hover { background: rgba(255,255,255,0.2); }
        
        .user-chip { 
            display: flex; align-items: center; gap: 10px; padding: 6px 12px;
            background: rgba(0,0,0,0.3); border-radius: 999px; border: 1px solid var(--border);
        }
        
        .grid { display: grid; grid-template-columns: 280px 1fr; gap: 20px; }
        @media(max-width: 900px) { .grid { grid-template-columns: 1fr; } }
        
        .card { 
            background: var(--panel); border: 1px solid var(--border);
            border-radius: 12px; padding: 20px;
        }
        
        /* Sidebar */
        .channel-list { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; max-height: 400px; overflow-y: auto; }
        .channel-item { 
            display: flex; align-items: center; gap: 10px; padding: 10px;
            background: rgba(255,255,255,0.03); border-radius: 8px;
            cursor: pointer; transition: all 0.2s;
        }
        .channel-item:hover { background: rgba(145,70,255,0.2); transform: translateX(4px); }
        .channel-item img { width: 32px; height: 32px; border-radius: 50%; }
        
        input { 
            width: 100%; padding: 12px; margin: 8px 0; background: rgba(0,0,0,0.3);
            border: 1px solid var(--border); color: white; border-radius: 8px;
        }
        input:focus { outline: none; border-color: var(--accent); }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        .clips-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px; margin-top: 20px;
        }
        .clip { 
            background: var(--bg1); border-radius: 12px; overflow: hidden;
            cursor: pointer; transition: transform 0.2s; border: 1px solid var(--border);
            position: relative;
        }
        .clip:hover { transform: translateY(-5px); border-color: var(--accent); }
        .clip-thumb { position: relative; aspect-ratio: 16/9; background: var(--bg2); }
        .clip-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .clip-duration { 
            position: absolute; bottom: 8px; right: 8px;
            background: rgba(0,0,0,0.8); padding: 4px 8px; border-radius: 4px;
            font-size: 12px; font-weight: bold;
        }
        .clip-edit { 
            position: absolute; top: 8px; right: 8px; background: var(--accent);
            padding: 6px 12px; border-radius: 4px; font-size: 11px; font-weight: bold;
            opacity: 0; transition: opacity 0.2s;
        }
        .clip:hover .clip-edit { opacity: 1; }
        .clip-info { padding: 14px; }
        .clip-title { font-weight: 700; font-size: 14px; margin-bottom: 6px; }
        .clip-meta { display: flex; gap: 12px; font-size: 12px; color: var(--muted); }
        
        .hidden { display: none !important; }
        
        /* Editor Modal */
        .modal { 
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95);
            z-index: 1000; padding: 20px; overflow: auto;
        }
        .modal.active { display: block; }
        
        .editor-box { 
            max-width: 1100px; margin: 20px auto; background: var(--bg1);
            border: 1px solid var(--border); border-radius: 16px; overflow: hidden;
        }
        
        .video-area { 
            position: relative; background: #000; aspect-ratio: 16/9;
            display: flex; align-items: center; justify-content: center;
        }
        
        /* WICHTIG: Twitch Embed braucht dieses Format */
        .video-area iframe, .video-area video {
            width: 100%; height: 100%; border: none;
        }
        
        .video-fallback { 
            position: absolute; inset: 0; display: flex; flex-direction: column;
            align-items: center; justify-content: center; background: rgba(0,0,0,0.9);
            color: var(--muted);
        }
        
        /* Timeline - CapCut Style */
        .timeline { padding: 20px; background: var(--bg0); }
        .time-display { 
            text-align: center; font-family: monospace; font-size: 20px;
            color: var(--accent-light); margin-bottom: 15px; font-weight: bold;
        }
        
        .track-container { 
            position: relative; height: 60px; background: var(--timeline);
            border-radius: 8px; margin: 20px 40px; cursor: pointer;
        }
        
        .track-bg { 
            position: absolute; inset: 0; background: var(--track);
            border-radius: 8px; margin: 10px 0;
        }
        
        .selection { 
            position: absolute; top: 10px; bottom: 10px;
            background: var(--selection); border: 2px solid var(--accent);
            border-radius: 4px; pointer-events: none;
        }
        
        .handle { 
            position: absolute; top: 5px; bottom: 5px; width: 12px;
            background: var(--accent); cursor: ew-resize; z-index: 10;
            border-radius: 3px; display: flex; align-items: center; justify-content: center;
        }
        .handle::after { content: ''; width: 2px; height: 20px; background: rgba(255,255,255,0.5); }
        .handle-left { transform: translateX(-50%); }
        .handle-right { transform: translateX(50%); }
        
        .playhead { 
            position: absolute; top: 0; bottom: 0; width: 2px;
            background: var(--playhead); z-index: 11; pointer-events: none;
            box-shadow: 0 0 10px var(--playhead);
        }
        .playhead::before { 
            content: ''; position: absolute; top: -5px; left: -4px;
            border-left: 5px solid transparent; border-right: 5px solid transparent;
            border-top: 8px solid var(--playhead);
        }
        
        .controls { 
            display: flex; justify-content: center; gap: 15px;
            padding: 15px; background: var(--bg1); border-top: 1px solid var(--border);
        }
        
        .export-bar { 
            padding: 20px; background: var(--bg2); border-top: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;
            gap: 10px;
        }
        
        .toast { 
            position: fixed; bottom: 20px; right: 20px; background: var(--bg1);
            padding: 16px 24px; border-radius: 12px; border-left: 4px solid var(--accent);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 2000;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <!-- Header -->
    <div class="header">
        <div style="display: flex; align-items: center; gap: 12px;">
            <div class="logo">üé¨</div>
            <div>
                <h1 style="font-size: 20px; margin: 0;">Twitch Studio</h1>
                <div style="font-size: 12px; color: var(--muted);">Clip Finder & Editor</div>
            </div>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-secondary" onclick="toggleSettings()">‚öôÔ∏è Einstellungen</button>
            <div id="userChip" class="user-chip hidden">
                <img id="userImg" style="width: 32px; height: 32px; border-radius: 50%;">
                <div id="userName" style="font-weight: 700;"></div>
                <button class="btn btn-secondary" style="padding: 6px 10px; font-size: 12px;" onclick="logout()">Logout</button>
            </div>
            <button class="btn" id="loginBtn" onclick="login()">Mit Twitch anmelden</button>
        </div>
    </div>

    <div class="grid">
        <!-- Sidebar -->
        <div class="card">
            <h3 style="margin-bottom: 15px;">‚≠ê Favoriten</h3>
            <input type="text" id="favInput" placeholder="Kanal hinzuf√ºgen..." onkeypress="if(event.key==='Enter')addFav()">
            <div id="channelList" class="channel-list"></div>
        </div>

        <!-- Main -->
        <div class="card">
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn" id="btnSearch" onclick="showView('search')">üîç Suche</button>
                <button class="btn btn-secondary" id="btnMine" onclick="showView('mine')">üë§ Meine Clips</button>
            </div>

            <div id="viewSearch">
                <input type="text" id="searchLogin" placeholder="Streamer Login (z.B. schradin)">
                <div class="row" style="margin-top: 10px;">
                    <input type="datetime-local" id="dateFrom">
                    <input type="datetime-local" id="dateTo">
                </div>
                <button class="btn" onclick="doSearch()" style="width: 100%; margin-top: 10px;">Suchen</button>
            </div>

            <div id="viewMine" class="hidden">
                <div class="row">
                    <input type="datetime-local" id="myDateFrom">
                    <input type="datetime-local" id="myDateTo">
                </div>
                <label style="display: flex; align-items: center; gap: 8px; margin-top: 10px; cursor: pointer;">
                    <input type="checkbox" id="onlyMine"> Nur meine erstellten Clips
                </label>
                <button class="btn" onclick="loadMyClips()" id="btnLoadMine" style="width: 100%; margin-top: 10px;" disabled>Laden</button>
                <div id="mineHint" style="margin-top: 10px; color: var(--muted); text-align: center;">Bitte anmelden</div>
            </div>

            <div id="errorMsg" style="color: var(--danger); margin-top: 10px; display: none;"></div>
            <div id="clipsArea" class="clips-grid"></div>
        </div>
    </div>
</div>

<!-- Settings -->
<div class="modal" id="settingsModal" onclick="if(event.target===this)toggleSettings()">
    <div class="card" style="max-width: 400px; margin: 100px auto;">
        <h3>Einstellungen</h3>
        <input type="text" id="clientId" placeholder="Twitch Client ID" style="margin-top: 15px;">
        <input type="text" id="scopes" value="user:read:follows" placeholder="Scopes">
        <button class="btn" onclick="saveSettings()" style="width: 100%; margin-top: 10px;">Speichern</button>
        <button class="btn btn-secondary" onclick="pasteToken()" style="width: 100%; margin-top: 8px;">Token eingeben</button>
    </div>
</div>

<!-- Editor -->
<div class="modal" id="editorModal">
    <div class="editor-box">
        <div style="padding: 15px 20px; background: var(--bg1); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
            <div style="font-weight: 700;">‚úÇÔ∏è Editor: <span id="edTitle" style="color: var(--muted); font-weight: 400;">-</span></div>
            <div>
                <button class="btn btn-secondary" onclick="saveProject()">üíæ Speichern</button>
                <button class="btn btn-secondary" onclick="closeEditor()" style="margin-left: 8px;">‚úï</button>
            </div>
        </div>

        <div class="video-area" id="videoContainer">
            <!-- Video oder Embed wird hier eingef√ºgt -->
            <div id="videoPlaceholder" style="color: var(--muted);">Lade Video...</div>
        </div>

        <div class="timeline">
            <div class="time-display" id="timeDisplay">00:00 / 00:00</div>
            
            <div class="track-container" id="trackContainer" onclick="seek(event)">
                <div class="track-bg"></div>
                <div class="selection" id="selection" style="left: 0%; width: 100%;"></div>
                <div class="playhead" id="playhead" style="left: 0%;"></div>
                <div class="handle handle-left" id="hStart" onmousedown="dragStart('start', event)"></div>
                <div class="handle handle-right" id="hEnd" onmousedown="dragStart('end', event)"></div>
            </div>

            <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--muted); margin-top: 5px; padding: 0 40px;">
                <span>0:00</span>
                <span id="lblStart">Start: 0:00</span>
                <span id="lblEnd">Ende: 0:00</span>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-secondary" onclick="markStart()">‚¨ÖÔ∏è Start</button>
            <button class="btn btn-secondary" onclick="skip(-5)">‚è™ -5s</button>
            <button class="btn" onclick="togglePlay()" id="playBtn">‚ñ∂Ô∏è Play</button>
            <button class="btn btn-secondary" onclick="skip(5)">+5s ‚è©</button>
            <button class="btn btn-secondary" onclick="markEnd()">Ende ‚û°Ô∏è</button>
        </div>

        <div class="export-bar">
            <div style="font-size: 13px; color: var(--muted);">
                üí° Hinweis: Echter Export ist im Browser nicht m√∂glich. Du kannst den Link mit Zeitangabe kopieren.
            </div>
            <div>
                <button class="btn btn-secondary" onclick="copyLink()">üìã Link kopieren</button>
                <button class="btn" onclick="openTwitch()">üîó Auf Twitch √∂ffnen</button>
            </div>
        </div>
    </div>
</div>

<script>
const LS = { cid: 'tc_cid', tok: 'tc_tok', fav: 'tc_fav', cut: 'tc_cut' };
let me = null, currentClip = null, duration = 60, start = 0, end = 60, isPlaying = false;
let useEmbed = false; // Wenn true, verwenden wir den Twitch Embed statt <video>

// Init
document.addEventListener('DOMContentLoaded', () => {
    const now = new Date(), ago = new Date(now - 86400000);
    const fmt = d => d.toISOString().slice(0, 16);
    ['dateFrom', 'dateTo', 'myDateFrom', 'myDateTo'].forEach((id, i) => {
        document.getElementById(id).value = fmt(i % 2 === 0 ? ago : now);
    });
    
    document.getElementById('clientId').value = localStorage.getItem(LS.cid) || '';
    
    loadFavs();
    if (location.hash.includes('access_token')) {
        const p = new URLSearchParams(location.hash.slice(1));
        localStorage.setItem(LS.tok, p.get('access_token'));
        history.replaceState(null, '', location.pathname);
        initUser();
    } else if (localStorage.getItem(LS.tok)) {
        initUser();
    }
});

function toggleSettings() { document.getElementById('settingsModal').classList.toggle('active'); }
function saveSettings() { 
    localStorage.setItem(LS.cid, document.getElementById('clientId').value); 
    toggleSettings(); 
    toast('Gespeichert'); 
}

function getCid() { return document.getElementById('clientId').value || localStorage.getItem(LS.cid) || ''; }
function getTok() { return localStorage.getItem(LS.tok) || ''; }

function login() {
    if (!getCid()) { toggleSettings(); return toast('Client ID fehlt!'); }
    localStorage.setItem(LS.cid, getCid());
    const redir = location.origin + location.pathname;
    const scp = document.getElementById('scopes').value || '';
    let url = `https://id.twitch.tv/oauth2/authorize?client_id=${getCid()}&redirect_uri=${redir}&response_type=token`;
    if (scp) url += `&scope=${encodeURIComponent(scp)}`;
    location.href = url;
}

async function api(path, params = {}) {
    const u = new URL('https://api.twitch.tv/helix' + path);
    Object.entries(params).forEach(([k, v]) => v && u.searchParams.append(k, String(v)));
    const r = await fetch(u, { headers: { 'Client-ID': getCid(), 'Authorization': 'Bearer ' + getTok() } });
    if (!r.ok) throw new Error((await r.json()).message || 'API Error');
    return r.json();
}

async function initUser() {
    try {
        const u = await api('/users');
        me = u.data[0];
        document.getElementById('loginBtn').classList.add('hidden');
        document.getElementById('userChip').classList.remove('hidden');
        document.getElementById('userName').textContent = me.display_name;
        document.getElementById('userImg').src = me.profile_image_url;
        document.getElementById('btnLoadMine').disabled = false;
        document.getElementById('mineHint').textContent = `Angemeldet als ${me.login}`;
        if (!favs.some(f => f.login === me.login)) addFav(me.login, me.display_name, me.profile_image_url);
    } catch (e) { logout(); }
}

function logout() { localStorage.removeItem(LS.tok); location.reload(); }
function pasteToken() { const t = prompt('Token:'); if (t) { localStorage.setItem(LS.tok, t); initUser(); } }

// Favorites
let favs = [];
function loadFavs() {
    try { favs = JSON.parse(localStorage.getItem(LS.fav)) || []; } catch(e) { favs = []; }
    renderFavs();
}
function saveFavs() { localStorage.setItem(LS.fav, JSON.stringify(favs)); }
function renderFavs() {
    document.getElementById('channelList').innerHTML = favs.map(f => `
        <div class="channel-item" onclick="selectFav('${f.login}')">
            <img src="${f.img || 'https://static-cdn.jtvnw.net/user-default-pictures-uv/13e5fa74-defa-11e9-809c-784f43822e80-profile_image-70x70.png'}">
            <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${f.name}</div>
                <div style="font-size: 12px; color: var(--muted);">@${f.login}</div>
            </div>
            ${f.login !== me?.login ? `<button onclick="event.stopPropagation(); delFav('${f.login}')" style="background:none; border:none; color: var(--danger); cursor: pointer;">üóë</button>` : ''}
        </div>
    `).join('');
}
function addFav(login, name, img) {
    login = login || document.getElementById('favInput').value.trim().toLowerCase();
    if (!login) return;
    if (!favs.some(f => f.login === login)) {
        favs.push({ login, name: name || login, img: img || '' });
        saveFavs(); renderFavs(); document.getElementById('favInput').value = '';
    }
}
function delFav(login) { favs = favs.filter(f => f.login !== login); saveFavs(); renderFavs(); }
function selectFav(l) { document.getElementById('searchLogin').value = l; showView('search'); doSearch(); }

// Views
function showView(v) {
    document.getElementById('viewSearch').classList.toggle('hidden', v !== 'search');
    document.getElementById('viewMine').classList.toggle('hidden', v !== 'mine');
    document.getElementById('btnSearch').className = v === 'search' ? 'btn' : 'btn btn-secondary';
    document.getElementById('btnMine').className = v === 'mine' ? 'btn' : 'btn btn-secondary';
}

// Search
async function doSearch() {
    const login = document.getElementById('searchLogin').value;
    if (!login) return;
    await fetchClips(login, document.getElementById('dateFrom').value, document.getElementById('dateTo').value);
}

async function loadMyClips() {
    if (!me) return;
    let clips = await fetchClips(me.login, document.getElementById('myDateFrom').value, document.getElementById('myDateTo').value);
    if (document.getElementById('onlyMine').checked) clips = clips.filter(c => c.creator_id === me.id);
    renderClips(clips);
}

async function fetchClips(login, from, to) {
    document.getElementById('errorMsg').style.display = 'none';
    document.getElementById('clipsArea').innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px;">Lade...</div>';
    try {
        const u = await api('/users', { login });
        if (!u.data[0]) throw new Error('Kanal nicht gefunden');
        const all = [], seen = new Set();
        let after = null;
        for (let i = 0; i < 10; i++) {
            const j = await api('/clips', { 
                broadcaster_id: u.data[0].id, 
                started_at: new Date(from).toISOString(), 
                ended_at: new Date(to).toISOString(), 
                first: 100, after 
            });
            (j.data || []).forEach(c => { if (!seen.has(c.id)) { seen.add(c.id); all.push(c); } });
            after = j.pagination?.cursor; if (!after) break;
        }
        renderClips(all.sort((a,b) => new Date(b.created_at) - new Date(a.created_at)));
        return all;
    } catch (e) { 
        document.getElementById('errorMsg').textContent = e.message; 
        document.getElementById('errorMsg').style.display = 'block'; 
    }
}

function renderClips(clips) {
    if (!clips.length) { document.getElementById('clipsArea').innerHTML = '<div style="text-align: center; padding: 40px; color: var(--muted);">Keine Clips</div>'; return; }
    document.getElementById('clipsArea').innerHTML = clips.map(c => {
        const thumb = c.thumbnail_url.replace('%{width}', '640').replace('%{height}', '360');
        return `
        <div class="clip" onclick="openEditor('${c.id}', '${c.url}', '${thumb}', '${c.title.replace(/'/g, "\\'")}', ${c.duration || 0})">
            <div class="clip-thumb">
                <img src="${thumb}" loading="lazy">
                <div class="clip-duration">${fmtDur(c.duration)}</div>
                <div class="clip-edit">BEARBEITEN</div>
            </div>
            <div class="clip-info">
                <div class="clip-title">${c.title}</div>
                <div class="clip-meta">
                    <span>üëÅÔ∏è ${c.view_count}</span>
                    <span>‚úÇÔ∏è ${c.creator_name}</span>
                </div>
            </div>
        </div>`;
    }).join('');
}

// EDITOR - KORRIGIERT
function openEditor(id, url, thumb, title, dur) {
    currentClip = { id, url, title, thumb };
    duration = dur || 60;
    start = 0; 
    end = duration;
    
    document.getElementById('edTitle').textContent = title.substring(0, 40);
    document.getElementById('editorModal').classList.add('active');
    
    const container = document.getElementById('videoContainer');
    container.innerHTML = ''; // Clear
    
    // Versuche zuerst direktes Video (funktioniert selten bei Twitch)
    // Daher verwenden wir direkt den Twitch-Embed, der immer funktioniert!
    useEmbed = true;
    
    // Extrahiere Clip-ID aus URL
    const clipId = url.split('/').pop().split('?')[0];
    const embedUrl = `https://clips.twitch.tv/embed?clip=${clipId}&parent=${location.hostname}&autoplay=false&muted=false`;
    
    const iframe = document.createElement('iframe');
    iframe.src = embedUrl;
    iframe.allowFullscreen = true;
    container.appendChild(iframe);
    
    updateUI();
    toast('Editor ge√∂ffnet. W√§hle Start und Ende.');
}

function closeEditor() { document.getElementById('editorModal').classList.remove('active'); }
function fmtDur(s) { const m = Math.floor(s/60), sec = Math.floor(s%60); return `${m}:${sec.toString().padStart(2,'0')}`; }
function fmt(s) { return fmtDur(s); }

function updateUI() {
    document.getElementById('timeDisplay').textContent = `${fmt(start)} - ${fmt(end)} / ${fmt(duration)}`;
    document.getElementById('lblStart').textContent = `Start: ${fmt(start)}`;
    document.getElementById('lblEnd').textContent = `Ende: ${fmt(end)}`;
    
    const sPct = (start / duration) * 100;
    const ePct = (end / duration) * 100;
    
    document.getElementById('selection').style.left = sPct + '%';
    document.getElementById('selection').style.width = (ePct - sPct) + '%';
    document.getElementById('hStart').style.left = sPct + '%';
    document.getElementById('hEnd').style.left = ePct + '%';
}

// Timeline Interaktion
function seek(e) {
    const rect = document.getElementById('trackContainer').getBoundingClientRect();
    const pct = (e.clientX - rect.left) / rect.width;
    const time = Math.max(0, Math.min(duration, pct * duration));
    // Setze Playhead visuell
    document.getElementById('playhead').style.left = (pct * 100) + '%';
}

function dragStart(type, e) {
    e.stopPropagation();
    const move = (ev) => {
        const rect = document.getElementById('trackContainer').getBoundingClientRect();
        const pct = Math.max(0, Math.min(1, (ev.clientX - rect.left) / rect.width));
        const time = pct * duration;
        
        if (type === 'start') {
            start = Math.min(time, end - 1);
        } else {
            end = Math.max(time, start + 1);
        }
        updateUI();
    };
    const up = () => {
        document.removeEventListener('mousemove', move);
        document.removeEventListener('mouseup', up);
    };
    document.addEventListener('mousemove', move);
    document.addEventListener('mouseup', up);
}

function markStart() { start = Math.min(end - 1, start); updateUI(); toast('Start: ' + fmt(start)); }
function markEnd() { end = Math.max(start + 1, end); updateUI(); toast('Ende: ' + fmt(end)); }
function skip(s) { /* Bei Embed k√∂nnen wir nicht skippen, also nur UI-Update */ }
function togglePlay() { 
    // Bei Embed starten wir neu mit Zeitparameter
    if (!currentClip) return;
    const iframe = document.querySelector('.video-area iframe');
    if (iframe) {
        const clipId = currentClip.url.split('/').pop().split('?')[0];
        const timeSec = Math.floor(start);
        iframe.src = `https://clips.twitch.tv/embed?clip=${clipId}&parent=${location.hostname}&autoplay=true&time=${timeSec}s`;
    }
}

function saveProject() {
    if (!currentClip) return;
    const arr = JSON.parse(localStorage.getItem(LS.cut) || '[]');
    arr.push({ ...currentClip, start, end, date: new Date().toISOString() });
    localStorage.setItem(LS.cut, JSON.stringify(arr));
    toast('Projekt gespeichert!');
}

function openTwitch() {
    if (!currentClip) return;
    window.open(`${currentClip.url}?t=${Math.floor(start)}s`, '_blank');
}

function copyLink() {
    if (!currentClip) return;
    navigator.clipboard.writeText(`${currentClip.url}?t=${Math.floor(start)}s-${Math.floor(end)}s`).then(() => toast('Link kopiert!'));
}

function toast(m) {
    const t = document.createElement('div'); 
    t.className = 'toast'; 
    t.textContent = m; 
    document.body.appendChild(t); 
    setTimeout(() => t.remove(), 3000);
}
</script>

</body>
</html>
