<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitch Clip Finder + CapCut Studio</title>
    <style>
        :root {
            --bg0: #0e0e10;
            --bg1: #18181b;
            --bg2: #1f1f23;
            --panel: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
            --text: #efeff1;
            --text-muted: #adadb8;
            --accent: #9146ff;
            --accent-light: #a970ff;
            --accent-dark: #5c16c5;
            --danger: #eb0400;
            --success: #00f593;
            --timeline-bg: #2d2d35;
            --timeline-track: #3d3d45;
            --playhead: #ff0050;
            --selection: rgba(145, 70, 255, 0.3);
            
            --radius: 12px;
            --radius-sm: 8px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg0);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Background Effect */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: 
                radial-gradient(1200px 600px at 20% 10%, rgba(145, 70, 255, 0.15), transparent 60%),
                radial-gradient(800px 400px at 80% 90%, rgba(145, 70, 255, 0.1), transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        
        .app {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            gap: 16px;
        }
        
        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            backdrop-filter: blur(10px);
        }
        
        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            border-radius: var(--radius-sm);
            display: grid;
            place-items: center;
            font-weight: bold;
            font-size: 20px;
            box-shadow: 0 0 20px rgba(145, 70, 255, 0.4);
        }
        
        .brand h1 {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(to right, #fff, var(--accent-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .brand span {
            font-size: 12px;
            color: var(--text-muted);
            display: block;
            margin-top: -2px;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        /* Buttons */
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: var(--radius-sm);
            background: var(--accent);
            color: white;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn:hover {
            background: var(--accent-light);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(145, 70, 255, 0.4);
        }
        
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover { background: rgba(255, 255, 255, 0.15); }
        
        .btn-ghost {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
        }
        
        .btn-ghost:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
        }
        
        .btn-icon {
            padding: 10px;
            aspect-ratio: 1;
        }
        
        /* User Chip */
        .user-chip {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 999px;
            border: 1px solid var(--border);
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg2);
            overflow: hidden;
            border: 2px solid var(--accent);
        }
        
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        
        .user-info { line-height: 1.2; }
        .user-name { font-weight: 700; font-size: 14px; }
        .user-id { font-size: 11px; color: var(--text-muted); }
        
        /* Main Layout */
        .workspace {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 16px;
            flex: 1;
            min-height: 0;
        }
        
        @media (max-width: 900px) {
            .workspace { grid-template-columns: 1fr; }
            .sidebar { max-height: 300px; }
        }
        
        /* Cards */
        .card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            font-size: 16px;
        }
        
        .card-body { padding: 20px; overflow-y: auto; }
        
        /* Sidebar */
        .sidebar-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            background: rgba(0, 0, 0, 0.2);
            padding: 4px;
            border-radius: var(--radius-sm);
        }
        
        .sidebar-tab {
            flex: 1;
            padding: 8px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .sidebar-tab.active {
            background: var(--accent);
            color: white;
        }
        
        .channel-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            max-height: calc(100vh - 300px);
            padding-right: 4px;
        }
        
        .channel-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid transparent;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
        }
        
        .channel-item:hover {
            background: rgba(145, 70, 255, 0.1);
            border-color: rgba(145, 70, 255, 0.3);
            transform: translateX(4px);
        }
        
        .channel-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg2);
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .channel-avatar img { width: 100%; height: 100%; object-fit: cover; }
        
        .channel-name {
            flex: 1;
            min-width: 0;
        }
        
        .channel-name .login {
            font-weight: 700;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .channel-name .category {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .channel-delete {
            opacity: 0;
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            padding: 4px;
            transition: opacity 0.2s;
        }
        
        .channel-item:hover .channel-delete { opacity: 1; }
        
        .add-channel {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .add-channel input {
            flex: 1;
            padding: 10px 14px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            outline: none;
        }
        
        .add-channel input:focus { border-color: var(--accent); }
        
        /* Main Content */
        .view-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .view-btn {
            flex: 1;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            color: var(--text-muted);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .view-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        .form-group { margin-bottom: 16px; }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        input[type="text"],
        input[type="datetime-local"] {
            width: 100%;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
        }
        
        input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(145, 70, 255, 0.2);
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            margin-top: 12px;
        }
        
        .checkbox-label input { width: auto; }
        
        /* Clips Grid */
        .clips-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .clip-card {
            background: var(--bg1);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .clip-card:hover {
            transform: translateY(-4px) scale(1.02);
            border-color: var(--accent);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4), 0 0 20px rgba(145, 70, 255, 0.2);
        }
        
        .clip-thumbnail {
            position: relative;
            aspect-ratio: 16/9;
            background: var(--bg2);
            overflow: hidden;
        }
        
        .clip-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s;
        }
        
        .clip-card:hover .clip-thumbnail img { transform: scale(1.1); }
        
        .clip-duration {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.8);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 700;
        }
        
        .clip-edit-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--accent);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s;
        }
        
        .clip-card:hover .clip-edit-badge {
            opacity: 1;
            transform: translateY(0);
        }
        
        .clip-info { padding: 16px; }
        
        .clip-title {
            font-weight: 700;
            font-size: 15px;
            line-height: 1.4;
            margin-bottom: 10px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .clip-meta {
            display: flex;
            gap: 12px;
            font-size: 13px;
            color: var(--text-muted);
        }
        
        .clip-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }
        
        .error {
            color: var(--danger);
            padding: 12px 16px;
            background: rgba(235, 4, 0, 0.1);
            border-radius: var(--radius-sm);
            margin-top: 12px;
            font-size: 14px;
        }
        
        /* Modal / Editor */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            z-index: 1000;
            display: none;
            place-items: center;
            padding: 20px;
        }
        
        .modal-overlay.active { display: grid; }
        
        .editor-container {
            width: 100%;
            max-width: 1200px;
            height: 90vh;
            background: var(--bg0);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 50px 100px rgba(0, 0, 0, 0.8);
        }
        
        .editor-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg1);
        }
        
        .editor-title {
            font-size: 18px;
            font-weight: 700;
        }
        
        .editor-title span {
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 400;
            margin-left: 8px;
        }
        
        .editor-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .editor-preview {
            flex: 1;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .editor-preview video {
            max-width: 100%;
            max-height: 100%;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        /* Timeline - CapCut Style */
        .editor-timeline {
            height: 200px;
            background: var(--bg1);
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 20px;
            gap: 16px;
        }
        
        .timeline-toolbar {
            display: flex;
            justify-content: center;
            gap: 12px;
        }
        
        .timeline-track-wrapper {
            flex: 1;
            background: var(--timeline-bg);
            border-radius: var(--radius-sm);
            position: relative;
            overflow: hidden;
        }
        
        .timeline-track {
            position: absolute;
            inset: 20px 40px;
            background: var(--timeline-track);
            border-radius: 4px;
            cursor: pointer;
        }
        
        .timeline-progress {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 0%;
            background: rgba(255, 255, 255, 0.1);
            pointer-events: none;
        }
        
        .timeline-selection {
            position: absolute;
            top: 0;
            bottom: 0;
            background: var(--selection);
            border-top: 2px solid var(--accent);
            border-bottom: 2px solid var(--accent);
        }
        
        .playhead {
            position: absolute;
            top: -10px;
            bottom: -10px;
            width: 2px;
            background: var(--playhead);
            transform: translateX(-50%);
            z-index: 10;
            pointer-events: none;
            box-shadow: 0 0 10px var(--playhead);
        }
        
        .playhead::before {
            content: '';
            position: absolute;
            top: 0;
            left: -4px;
            width: 10px;
            height: 10px;
            background: var(--playhead);
            border-radius: 2px 2px 0 0;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
        }
        
        .handle {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 12px;
            background: var(--accent);
            cursor: ew-resize;
            z-index: 11;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }
        
        .handle::before {
            content: '';
            width: 2px;
            height: 20px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 1px;
        }
        
        .handle-left { transform: translateX(-50%); }
        .handle-right { transform: translateX(50%); }
        
        .time-markers {
            position: absolute;
            bottom: 4px;
            left: 40px;
            right: 40px;
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-muted);
            pointer-events: none;
        }
        
        .editor-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding: 16px;
            background: var(--bg1);
            border-top: 1px solid var(--border);
        }
        
        .time-display {
            font-family: 'Courier New', monospace;
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-light);
            min-width: 120px;
            text-align: center;
        }
        
        .export-panel {
            padding: 16px 24px;
            background: var(--bg2);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }
        
        .export-info {
            font-size: 13px;
            color: var(--text-muted);
        }
        
        .export-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 16px 24px;
            background: var(--bg1);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 2000;
            animation: slideIn 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
    </style>
</head>
<body>

<div class="app">
    <!-- Header -->
    <header class="header">
        <div class="brand">
            <div class="logo">üé¨</div>
            <div>
                <h1>Twitch Studio</h1>
                <span>Clip Finder & Editor</span>
            </div>
        </div>
        
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="toggleSettings()">‚öôÔ∏è Einstellungen</button>
            <div id="userSection" style="display: none;">
                <div class="user-chip">
                    <div class="user-avatar" id="userAvatar"></div>
                    <div class="user-info">
                        <div class="user-name" id="userName">-</div>
                        <div class="user-id" id="userLogin">-</div>
                    </div>
                    <button class="btn btn-ghost btn-icon" onclick="logout()" title="Logout">üö™</button>
                </div>
            </div>
            <button class="btn" id="loginBtn" onclick="login()">üîê Mit Twitch anmelden</button>
        </div>
    </header>

    <!-- Workspace -->
    <div class="workspace">
        <!-- Sidebar -->
        <aside class="card sidebar">
            <div class="card-header">
                üìã Kan√§le
            </div>
            <div class="card-body" style="padding: 16px;">
                <div class="sidebar-tabs">
                    <button class="sidebar-tab active" onclick="switchTab('favs')" id="tab-favs">‚≠ê Favoriten</button>
                    <button class="sidebar-tab" onclick="switchTab('follows')" id="tab-follows">üë• Follows</button>
                </div>
                
                <div id="favInputArea">
                    <div class="add-channel">
                        <input type="text" id="newChannelInput" placeholder="Kanal hinzuf√ºgen..." onkeypress="if(event.key==='Enter')addFavorite()">
                        <button class="btn btn-secondary" onclick="addFavorite()">+</button>
                    </div>
                </div>
                
                <div class="channel-list" id="channelList">
                    <!-- Channels loaded here -->
                </div>
            </div>
        </aside>

        <!-- Main Panel -->
        <main class="card" style="flex: 1;">
            <div class="card-body">
                <!-- View Toggle -->
                <div class="view-toggle">
                    <button class="view-btn active" onclick="setView('search')" id="btn-view-search">
                        üîç Clips suchen
                    </button>
                    <button class="view-btn" onclick="setView('mine')" id="btn-view-mine">
                        üë§ Meine Clips
                    </button>
                </div>

                <!-- Search View -->
                <div id="view-search">
                    <div class="form-group">
                        <label>Streamer Login</label>
                        <input type="text" id="searchLogin" placeholder="z.B. schradin, zarbex, montanablack...">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Von (Datum & Uhrzeit)</label>
                            <input type="datetime-local" id="dateFrom">
                        </div>
                        <div class="form-group">
                            <label>Bis (Datum & Uhrzeit)</label>
                            <input type="datetime-local" id="dateTo">
                        </div>
                    </div>
                    
                    <button class="btn" onclick="searchClips()" style="width: 100%; margin-top: 8px;">
                        üîç Suche starten
                    </button>
                </div>

                <!-- My Channel View -->
                <div id="view-mine" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Von</label>
                            <input type="datetime-local" id="myDateFrom">
                        </div>
                        <div class="form-group">
                            <label>Bis</label>
                            <input type="datetime-local" id="myDateTo">
                        </div>
                    </div>
                    
                    <label class="checkbox-label">
                        <input type="checkbox" id="onlyMyClips">
                        <span>Nur Clips anzeigen, die ich erstellt habe</span>
                    </label>
                    
                    <button class="btn" onclick="loadMyClips()" id="btnLoadMine" style="width: 100%; margin-top: 16px;" disabled>
                        üë§ Meine Clips laden
                    </button>
                    
                    <div class="hint" id="mineHint" style="margin-top: 12px; text-align: center;">
                        Bitte melde dich an, um deine Clips zu sehen.
                    </div>
                </div>

                <div class="error" id="errorMsg" style="display: none;"></div>
                <div class="loading" id="loading">‚è≥ Lade...</div>
                
                <!-- Results -->
                <div class="clips-grid" id="clipsContainer"></div>
            </div>
        </main>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settingsModal" onclick="if(event.target===this)toggleSettings()">
    <div class="card" style="width: 90%; max-width: 450px; max-height: 80vh;">
        <div class="card-header">
            ‚öôÔ∏è Einstellungen
            <button class="btn btn-ghost btn-icon" onclick="toggleSettings()">‚úï</button>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label>Twitch Client ID</label>
                <input type="text" id="clientId" placeholder="Deine Client ID von dev.twitch.tv">
            </div>
            
            <div class="form-group">
                <label>OAuth Scopes</label>
                <input type="text" id="scopes" value="user:read:follows" placeholder="user:read:follows clips:edit">
                <div class="hint" style="margin-top: 6px;">
                    F√ºr Follower-Liste: <code>user:read:follows</code>
                </div>
            </div>
            
            <button class="btn" onclick="saveSettings()" style="width: 100%;">üíæ Speichern</button>
            <button class="btn btn-secondary" onclick="importToken()" style="width: 100%; margin-top: 8px;">üîë Token manuell eingeben</button>
            <button class="btn btn-ghost" onclick="clearAllData()" style="width: 100%; margin-top: 8px;">üóëÔ∏è Alle Daten l√∂schen</button>
        </div>
    </div>
</div>

<!-- CapCut Editor Modal -->
<div class="modal-overlay" id="editorModal">
    <div class="editor-container">
        <div class="editor-header">
            <div class="editor-title">
                ‚úÇÔ∏è CapCut Editor
                <span id="editorClipTitle">-</span>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="testLoop()">üîÅ Test-Loop</button>
                <button class="btn" onclick="saveProject()">üíæ Projekt speichern</button>
                <button class="btn btn-ghost" onclick="closeEditor()">‚úï</button>
            </div>
        </div>
        
        <div class="editor-main">
            <div class="editor-preview">
                <video id="editorVideo" playsinline></video>
            </div>
            
            <div class="editor-timeline">
                <div class="timeline-toolbar">
                    <button class="btn btn-secondary btn-icon" onclick="skip(-10)">‚è™</button>
                    <button class="btn btn-icon" onclick="togglePlay()" id="playPauseBtn" style="width: 50px; height: 50px; font-size: 20px;">‚ñ∂</button>
                    <button class="btn btn-secondary btn-icon" onclick="skip(10)">‚è©</button>
                </div>
                
                <div class="timeline-track-wrapper" id="trackWrapper">
                    <div class="timeline-track" id="timelineTrack" onclick="seek(event)">
                        <div class="timeline-selection" id="selectionRange"></div>
                        <div class="playhead" id="playhead"></div>
                        <div class="handle handle-left" id="handleStart" onmousedown="startDrag('start', event)"></div>
                        <div class="handle handle-right" id="handleEnd" onmousedown="startDrag('end', event)"></div>
                    </div>
                    <div class="time-markers">
                        <span>0:00</span>
                        <span id="markerMid">-</span>
                        <span id="markerEnd">-</span>
                    </div>
                </div>
                
                <div style="display: flex; gap: 20px; justify-content: center; margin-top: 10px;">
                    <button class="btn btn-secondary" onclick="markStart()">‚¨ÖÔ∏è Start setzen</button>
                    <div class="time-display" id="timeDisplay">00:00 / 00:00</div>
                    <button class="btn btn-secondary" onclick="markEnd()">Ende setzen ‚û°Ô∏è</button>
                </div>
            </div>
        </div>
        
        <div class="export-panel">
            <div class="export-info">
                ‚ö†Ô∏è <strong>Hinweis:</strong> Echter Video-Export ist im Browser nicht m√∂glich (Twitch CORS). 
                Du kannst den Clip aber mit deinem Schnitt auf Twitch √∂ffnen oder den Link kopieren.
            </div>
            <div class="export-actions">
                <button class="btn btn-secondary" onclick="copyTimeLink()">üìã Link kopieren</button>
                <button class="btn" onclick="openOnTwitch()">üîó Auf Twitch √∂ffnen</button>
            </div>
        </div>
    </div>
</div>

<script>
// State
const LS = {
    CLIENT_ID: 'tcf_client_id',
    TOKEN: 'tcf_token',
    SCOPES: 'tcf_scopes',
    FAVORITES: 'tcf_favorites',
    PROJECTS: 'tcf_projects'
};

let state = {
    user: null,
    clips: [],
    favorites: [],
    follows: [],
    currentView: 'search',
    sidebarTab: 'favs',
    editor: {
        clip: null,
        duration: 0,
        start: 0,
        end: 0,
        isPlaying: false,
        isDragging: null
    }
};

// Init
document.addEventListener('DOMContentLoaded', () => {
    // Set default dates
    const now = new Date();
    const yesterday = new Date(now - 24 * 60 * 60 * 1000);
    
    const fmt = d => d.toISOString().slice(0, 16);
    document.getElementById('dateFrom').value = fmt(yesterday);
    document.getElementById('dateTo').value = fmt(now);
    document.getElementById('myDateFrom').value = fmt(yesterday);
    document.getElementById('myDateTo').value = fmt(now);
    
    // Load saved data
    document.getElementById('clientId').value = localStorage.getItem(LS.CLIENT_ID) || '';
    document.getElementById('scopes').value = localStorage.getItem(LS.SCOPES) || 'user:read:follows';
    loadFavorites();
    
    // Check auth
    if (parseAuthCallback()) {
        setTimeout(() => initUser(), 500);
    } else if (localStorage.getItem(LS.TOKEN)) {
        initUser();
    } else {
        renderSidebar();
    }
});

// Auth Functions
function parseAuthCallback() {
    const hash = window.location.hash;
    if (!hash.includes('access_token')) return false;
    
    const params = new URLSearchParams(hash.slice(1));
    const token = params.get('access_token');
    
    if (token) {
        localStorage.setItem(LS.TOKEN, token);
        localStorage.setItem(LS.SCOPES, params.get('scope') || document.getElementById('scopes').value);
        window.history.replaceState({}, document.title, window.location.pathname);
        return true;
    }
    return false;
}

function login() {
    const clientId = document.getElementById('clientId').value.trim();
    if (!clientId) {
        showToast('Bitte gib zuerst eine Client ID in den Einstellungen ein!', 'error');
        toggleSettings();
        return;
    }
    
    localStorage.setItem(LS.CLIENT_ID, clientId);
    localStorage.setItem(LS.SCOPES, document.getElementById('scopes').value);
    
    const redirect = window.location.origin + window.location.pathname;
    const scopes = document.getElementById('scopes').value.trim();
    const state = Math.random().toString(36).substring(7);
    
    let url = `https://id.twitch.tv/oauth2/authorize?client_id=${clientId}&redirect_uri=${redirect}&response_type=token&state=${state}`;
    if (scopes) url += `&scope=${encodeURIComponent(scopes)}`;
    
    window.location.href = url;
}

function logout() {
    localStorage.removeItem(LS.TOKEN);
    state.user = null;
    updateAuthUI();
    renderSidebar();
    showToast('Ausgeloggt');
}

async function initUser() {
    try {
        const user = await api('/users');
        if (!user.data || !user.data[0]) throw new Error('No user');
        
        state.user = user.data[0];
        updateAuthUI();
        
        // Add self to favorites if not there
        if (!state.favorites.some(f => f.login === state.user.login)) {
            state.favorites.unshift({
                login: state.user.login,
                display_name: state.user.display_name,
                profile_image_url: state.user.profile_image_url,
                isUser: true
            });
            saveFavorites();
        }
        
        renderSidebar();
        
        // Load follows in background if scope exists
        if ((localStorage.getItem(LS.SCOPES) || '').includes('user:read:follows')) {
            loadFollows();
        }
    } catch (e) {
        console.error('Auth error:', e);
        localStorage.removeItem(LS.TOKEN);
        showToast('Session abgelaufen. Bitte neu anmelden.', 'error');
    }
}

function updateAuthUI() {
    const hasUser = !!state.user;
    document.getElementById('loginBtn').style.display = hasUser ? 'none' : 'block';
    document.getElementById('userSection').style.display = hasUser ? 'flex' : 'none';
    document.getElementById('btnLoadMine').disabled = !hasUser;
    
    if (hasUser) {
        document.getElementById('userName').textContent = state.user.display_name;
        document.getElementById('userLogin').textContent = '@' + state.user.login;
        document.getElementById('userAvatar').innerHTML = `<img src="${state.user.profile_image_url}" alt="">`;
        document.getElementById('mineHint').innerHTML = `Angemeldet als <strong>${state.user.display_name}</strong>. W√§hle einen Zeitraum f√ºr deine Clips.`;
    }
}

// API Helper
async function api(endpoint, params = {}) {
    const url = new URL('https://api.twitch.tv/helix' + endpoint);
    Object.entries(params).forEach(([k, v]) => v != null && url.searchParams.append(k, v));
    
    const res = await fetch(url, {
        headers: {
            'Client-ID': getClientId(),
            'Authorization': `Bearer ${localStorage.getItem(LS.TOKEN)}`
        }
    });
    
    if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.message || `HTTP ${res.status}`);
    }
    
    return res.json();
}

function getClientId() {
    return document.getElementById('clientId').value.trim() || localStorage.getItem(LS.CLIENT_ID) || '';
}

// Sidebar Management
function switchTab(tab) {
    state.sidebarTab = tab;
    document.getElementById('tab-favs').classList.toggle('active', tab === 'favs');
    document.getElementById('tab-follows').classList.toggle('active', tab === 'follows');
    document.getElementById('favInputArea').style.display = tab === 'favs' ? 'block' : 'none';
    renderSidebar();
}

function renderSidebar() {
    const list = document.getElementById('channelList');
    const query = (document.getElementById('newChannelInput')?.value || '').toLowerCase();
    
    let items = state.sidebarTab === 'favs' ? state.favorites : state.follows;
    
    if (query) {
        items = items.filter(c => 
            c.login.toLowerCase().includes(query) || 
            (c.display_name && c.display_name.toLowerCase().includes(query))
        );
    }
    
    if (items.length === 0) {
        list.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">Keine Kan√§le</div>';
        return;
    }
    
    list.innerHTML = items.map(channel => `
        <div class="channel-item" onclick="selectChannel('${channel.login}')">
            <div class="channel-avatar">
                <img src="${channel.profile_image_url || 'https://static-cdn.jtvnw.net/user-default-pictures-uv/13e5fa74-defa-11e9-809c-784f43822e80-profile_image-70x70.png'}" 
                     onerror="this.src='https://static-cdn.jtvnw.net/user-default-pictures-uv/13e5fa74-defa-11e9-809c-784f43822e80-profile_image-70x70.png'">
            </div>
            <div class="channel-name">
                <div class="login">${channel.display_name || channel.login}</div>
                <div class="category">@${channel.login}</div>
            </div>
            ${!channel.isUser && state.sidebarTab === 'favs' ? 
                `<button class="channel-delete" onclick="event.stopPropagation(); removeFavorite('${channel.login}')">üóëÔ∏è</button>` : ''}
        </div>
    `).join('');
}

function selectChannel(login) {
    document.getElementById('searchLogin').value = login;
    setView('search');
    searchClips();
}

function addFavorite() {
    const input = document.getElementById('newChannelInput');
    const login = input.value.trim().toLowerCase();
    if (!login) return;
    
    if (!state.favorites.some(f => f.login === login)) {
        state.favorites.push({
            login: login,
            display_name: login,
            profile_image_url: '',
            isUser: false
        });
        saveFavorites();
        renderSidebar();
        input.value = '';
        showToast('Zur Favoritenliste hinzugef√ºgt');
    }
}

function removeFavorite(login) {
    state.favorites = state.favorites.filter(f => f.login !== login);
    saveFavorites();
    renderSidebar();
}

function saveFavorites() {
    localStorage.setItem(LS.FAVORITES, JSON.stringify(state.favorites));
}

function loadFavorites() {
    try {
        const raw = localStorage.getItem(LS.FAVORITES);
        if (raw) state.favorites = JSON.parse(raw);
    } catch (e) { state.favorites = []; }
}

async function loadFollows() {
    if (!state.user) return;
    try {
        const all = [];
        let cursor = null;
        
        // Load all pages (up to 1000 for safety)
        for (let i = 0; i < 10; i++) {
            const params = { user_id: state.user.id, first: 100 };
            if (cursor) params.after = cursor;
            
            const res = await api('/channels/followed', params);
            if (!res.data) break;
            
            all.push(...res.data);
            cursor = res.pagination?.cursor;
            if (!cursor) break;
        }
        
        // Get user details for images
        const userIds = all.map(f => f.broadcaster_id);
        const users = {};
        
        // Batch in groups of 100
        for (let i = 0; i < userIds.length; i += 100) {
            const batch = userIds.slice(i, i + 100);
            const url = new URL('https://api.twitch.tv/helix/users');
            batch.forEach(id => url.searchParams.append('id', id));
            
            const res = await fetch(url, {
                headers: {
                    'Client-ID': getClientId(),
                    'Authorization': `Bearer ${localStorage.getItem(LS.TOKEN)}`
                }
            });
            const data = await res.json();
            if (data.data) {
                data.data.forEach(u => users[u.id] = u);
            }
        }
        
        state.follows = all.map(f => ({
            login: f.broadcaster_login,
            display_name: f.broadcaster_name,
            profile_image_url: users[f.broadcaster_id]?.profile_image_url || '',
            fromFollows: true
        })).sort((a, b) => a.display_name.localeCompare(b.display_name));
        
        if (state.sidebarTab === 'follows') renderSidebar();
    } catch (e) {
        console.error('Failed to load follows:', e);
        showToast('Follows konnten nicht geladen werden (Scope fehlt?)', 'error');
    }
}

// View Management
function setView(view) {
    state.currentView = view;
    document.getElementById('view-search').style.display = view === 'search' ? 'block' : 'none';
    document.getElementById('view-mine').style.display = view === 'mine' ? 'block' : 'none';
    document.getElementById('btn-view-search').classList.toggle('active', view === 'search');
    document.getElementById('btn-view-mine').classList.toggle('active', view === 'mine');
    document.getElementById('errorMsg').style.display = 'none';
}

// Search Functions
async function searchClips() {
    const login = document.getElementById('searchLogin').value.trim();
    const from = document.getElementById('dateFrom').value;
    const to = document.getElementById('dateTo').value;
    
    if (!login || !from || !to) {
        showError('Bitte f√ºlle alle Felder aus');
        return;
    }
    
    await fetchClipsForUser(login, from, to);
}

async function loadMyClips() {
    if (!state.user) {
        showError('Bitte melde dich an');
        return;
    }
    
    const from = document.getElementById('myDateFrom').value;
    const to = document.getElementById('myDateTo').value;
    const onlyMine = document.getElementById('onlyMyClips').checked;
    
    await fetchClipsForUser(state.user.login, from, to, onlyMine ? state.user.id : null);
}

async function fetchClipsForUser(login, from, to, creatorIdFilter = null) {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('errorMsg').style.display = 'none';
    document.getElementById('clipsContainer').innerHTML = '';
    
    try {
        // Get user ID
        const userRes = await api('/users', { login });
        if (!userRes.data || !userRes.data[0]) {
            throw new Error('Kanal nicht gefunden');
        }
        
        const userId = userRes.data[0].id;
        
        // Fetch all clips with pagination
        const allClips = [];
        let cursor = null;
        
        for (let i = 0; i < 15; i++) { // Safety limit
            const params = {
                broadcaster_id: userId,
                started_at: new Date(from).toISOString(),
                ended_at: new Date(to).toISOString(),
                first: 100
            };
            if (cursor) params.after = cursor;
            
            const res = await api('/clips', params);
            if (res.data) {
                allClips.push(...res.data);
                cursor = res.pagination?.cursor;
                if (!cursor || res.data.length === 0) break;
            }
        }
        
        // Filter by creator if needed
        let finalClips = allClips;
        if (creatorIdFilter) {
            finalClips = allClips.filter(c => c.creator_id === creatorIdFilter);
        }
        
        // Sort by date
        finalClips.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        
        renderClips(finalClips);
        showToast(`${finalClips.length} Clips gefunden`, 'success');
        
    } catch (e) {
        showError(e.message);
    } finally {
        document.getElementById('loading').style.display = 'none';
    }
}

function renderClips(clips) {
    const container = document.getElementById('clipsContainer');
    
    if (clips.length === 0) {
        container.innerHTML = '<div class="hint" style="text-align: center; padding: 40px;">Keine Clips gefunden</div>';
        return;
    }
    
    container.innerHTML = clips.map(clip => {
        const thumb = clip.thumbnail_url
            .replace('%{width}', '640')
            .replace('%{height}', '360');
        const duration = formatDuration(clip.duration);
        
        return `
        <div class="clip-card" onclick="openEditor('${clip.id}', '${clip.url}', '${thumb}', '${escapeHtml(clip.title)}', ${clip.duration})">
            <div class="clip-thumbnail">
                <img src="${thumb}" loading="lazy" onerror="this.src='${thumb.replace('640x360', '480x272')}'">
                <div class="clip-duration">${duration}</div>
                <div class="clip-edit-badge">‚úÇÔ∏è Bearbeiten</div>
            </div>
            <div class="clip-info">
                <div class="clip-title">${escapeHtml(clip.title)}</div>
                <div class="clip-meta">
                    <span>üëÅÔ∏è ${formatNumber(clip.view_count)}</span>
                    <span>‚úÇÔ∏è ${escapeHtml(clip.creator_name)}</span>
                    <span>üìÖ ${new Date(clip.created_at).toLocaleDateString('de-DE')}</span>
                </div>
            </div>
        </div>
        `;
    }).join('');
}

// CapCut Editor
function openEditor(id, url, thumb, title, duration) {
    state.editor.clip = { id, url, title, thumbnail: thumb };
    state.editor.duration = duration || 60;
    state.editor.start = 0;
    state.editor.end = state.editor.duration;
    
    document.getElementById('editorClipTitle').textContent = '- ' + (title.length > 40 ? title.substring(0, 40) + '...' : title);
    document.getElementById('editorModal').classList.add('active');
    
    const video = document.getElementById('editorVideo');
    video.src = url;
    video.load();
    
    video.onloadedmetadata = () => {
        state.editor.duration = video.duration || duration || 60;
        state.editor.end = state.editor.duration;
        updateTimelineUI();
        updateTimeDisplay();
    };
    
    video.ontimeupdate = () => {
        updatePlayhead();
        checkLoop();
    };
    
    video.onplay = () => {
        state.editor.isPlaying = true;
        document.getElementById('playPauseBtn').textContent = '‚è∏';
    };
    
    video.onpause = () => {
        state.editor.isPlaying = false;
        document.getElementById('playPauseBtn').textContent = '‚ñ∂';
    };
}

function closeEditor() {
    document.getElementById('editorModal').classList.remove('active');
    document.getElementById('editorVideo').pause();
    state.editor.isPlaying = false;
}

function togglePlay() {
    const video = document.getElementById('editorVideo');
    if (video.paused) video.play();
    else video.pause();
}

function skip(seconds) {
    const video = document.getElementById('editorVideo');
    video.currentTime = Math.max(0, Math.min(video.duration || state.editor.duration, video.currentTime + seconds));
}

function seek(event) {
    const track = document.getElementById('timelineTrack');
    const rect = track.getBoundingClientRect();
    const pct = Math.max(0, Math.min(1, (event.clientX - rect.left) / rect.width));
    const time = pct * state.editor.duration;
    
    document.getElementById('editorVideo').currentTime = time;
    updatePlayhead();
}

function markStart() {
    const video = document.getElementById('editorVideo');
    state.editor.start = Math.min(video.currentTime, state.editor.end - 1);
    updateTimelineUI();
    showToast('Start-Marke gesetzt: ' + formatTime(state.editor.start));
}

function markEnd() {
    const video = document.getElementById('editorVideo');
    state.editor.end = Math.max(video.currentTime, state.editor.start + 1);
    updateTimelineUI();
    showToast('End-Marke gesetzt: ' + formatTime(state.editor.end));
}

function updatePlayhead() {
    const video = document.getElementById('editorVideo');
    const pct = (video.currentTime / state.editor.duration) * 100;
    document.getElementById('playhead').style.left = pct + '%';
    updateTimeDisplay();
}

function updateTimelineUI() {
    const startPct = (state.editor.start / state.editor.duration) * 100;
    const endPct = (state.editor.end / state.editor.duration) * 100;
    const width = endPct - startPct;
    
    const selection = document.getElementById('selectionRange');
    selection.style.left = startPct + '%';
    selection.style.width = width + '%';
    
    document.getElementById('handleStart').style.left = startPct + '%';
    document.getElementById('handleEnd').style.left = endPct + '%';
    
    document.getElementById('markerMid').textContent = formatTime(state.editor.duration / 2);
    document.getElementById('markerEnd').textContent = formatTime(state.editor.duration);
    
    updateTimeDisplay();
}

function updateTimeDisplay() {
    const video = document.getElementById('editorVideo');
    const current = video.currentTime || 0;
    document.getElementById('timeDisplay').textContent = 
        formatTime(current) + ' / ' + formatTime(state.editor.duration);
}

function checkLoop() {
    const video = document.getElementById('editorVideo');
    if (video.currentTime >= state.editor.end) {
        video.currentTime = state.editor.start;
        if (!video.paused) video.play();
    }
}

function testLoop() {
    const video = document.getElementById('editorVideo');
    video.currentTime = state.editor.start;
    video.play();
}

function startDrag(type, event) {
    state.editor.isDragging = type;
    document.body.style.cursor = 'ew-resize';
    event.preventDefault();
    
    const onMove = (e) => {
        const track = document.getElementById('timelineTrack');
        const rect = track.getBoundingClientRect();
        const pct = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
        const time = pct * state.editor.duration;
        
        if (type === 'start') {
            state.editor.start = Math.min(time, state.editor.end - 0.5);
        } else {
            state.editor.end = Math.max(time, state.editor.start + 0.5);
        }
        updateTimelineUI();
    };
    
    const onUp = () => {
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
        document.body.style.cursor = '';
        state.editor.isDragging = null;
    };
    
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
}

function saveProject() {
    if (!state.editor.clip) return;
    
    const projects = JSON.parse(localStorage.getItem(LS.PROJECTS) || '[]');
    projects.push({
        ...state.editor.clip,
        start: state.editor.start,
        end: state.editor.end,
        created: new Date().toISOString()
    });
    
    localStorage.setItem(LS.PROJECTS, JSON.stringify(projects));
    showToast('Projekt gespeichert!');
}

function openOnTwitch() {
    if (!state.editor.clip) return;
    const url = `${state.editor.clip.url}?t=${Math.floor(state.editor.start)}s`;
    window.open(url, '_blank');
}

function copyTimeLink() {
    if (!state.editor.clip) return;
    const url = `${state.editor.clip.url}?t=${Math.floor(state.editor.start)}s-${Math.floor(state.editor.end)}s`;
    navigator.clipboard.writeText(url).then(() => showToast('Link kopiert!'));
}

// Settings
function toggleSettings() {
    document.getElementById('settingsModal').classList.toggle('active');
}

function saveSettings() {
    localStorage.setItem(LS.CLIENT_ID, document.getElementById('clientId').value.trim());
    localStorage.setItem(LS.SCOPES, document.getElementById('scopes').value.trim());
    showToast('Einstellungen gespeichert');
    toggleSettings();
}

function importToken() {
    const token = prompt('OAuth Token eingeben (ohne "Bearer"):');
    if (token) {
        localStorage.setItem(LS.TOKEN, token.trim());
        initUser();
        showToast('Token importiert');
    }
}

function clearAllData() {
    if (!confirm('Wirklich ALLE Daten l√∂schen?')) return;
    Object.values(LS).forEach(key => localStorage.removeItem(key));
    location.reload();
}

// Utilities
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatDuration(seconds) {
    if (!seconds) return '0:00';
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function formatNumber(num) {
    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
    return num.toString();
}

function showError(msg) {
    const el = document.getElementById('errorMsg');
    el.textContent = msg;
    el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 5000);
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = (type === 'error' ? '‚ùå ' : '‚úÖ ') + message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}
</script>

</body>
</html>
